<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vinylregister ‚Äì v8.7 (Native, environment-only)</title>
  <style>
    :root { --fg:#111; --muted:#555; --line:#e5e5e5; --bg:#ffffff; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); background:#fff; margin:16px; }
    h1{ margin:0 0 12px; }
    .wrap{ border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    .wrap-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field span{ font-size:.9rem; color:var(--muted); }
    input.manual{ padding:8px; border:1px solid #dbe7ff; border-radius:8px; background:#f8fbff; }
    input.manual:focus{ outline:2px solid #9ec5ff; background:#fff; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn{ border:1px solid var(--line); border-radius:10px; padding:8px 12px; background:#fafafa; cursor:pointer; }
    .btn:hover{ background:#f0f0f0; }
    .btn.primary{ border-color:#cce2ff; background:#eef6ff; }
    .btn.danger{ border-color:#f3c2c2; background:#fff5f5; }
    .btn.danger:hover{ background:#ffecec; }
    .note{ font-size:12px; color:var(--muted); }
    .badge{ position:fixed; right:12px; bottom:12px; background:#F0FFF5; border:1px solid #9ad27e; padding:4px 8px; border-radius:6px; font-size:12px; z-index:99999; white-space:nowrap; }
    .badge-left{ position:fixed; left:12px; bottom:12px; background:#F0FFF5; border:1px solid #9ad27e; padding:4px 8px; border-radius:6px; font-size:12px; z-index:99999; white-space:nowrap; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:56px; background:#222; color:#fff; font-size:12px; padding:8px 12px; border-radius:8px; z-index:99999; opacity:.95; }
    /* Scanner overlay */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:9999; }
    .scan-card{ background:#fff; border-radius:12px; padding:12px; width:min(860px, 96vw); }
    .scan-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .scan-video{ width:100%; border-radius:8px; background:#000; aspect-ratio:16/9; }
    .status{ font-size:12px; color:#333; padding:4px 8px; background:#f5f5f5; border:1px solid #eee; border-radius:6px; }
    #log{ font-family:ui-monospace,Consolas,monospace; font-size:12px; white-space:pre-wrap; background:#f7f7f7; border:1px solid #eee; border-radius:8px; padding:8px; margin-top:8px; max-height:220px; overflow:auto; }
  </style>
</head>
<body>
  <h1>Vinylregister ‚Äì v8.7 (Native, environment-only)</h1>

  <div class="wrap">
    <div class="wrap-head">
      <h2>Inmatning</h2>
      <div class="row">
        <button class="btn primary" id="btnScanLive">üì∑ Live-skanning</button>
        <button class="btn" id="btnScanPhoto">üì∏ Foto (failsafe)</button>
      </div>
    </div>
    <div class="grid">
      <label class="field"><span>Artist</span><input id="artist" class="manual" type="text"></label>
      <label class="field"><span>Album</span><input id="album" class="manual" type="text"></label>
      <label class="field"><span>√Ör</span><input id="year" class="manual" type="number" step="1"></label>
      <label class="field"><span>Format</span><input id="format" class="manual" type="text"></label>
      <label class="field"><span>EAN</span><input id="ean" class="manual" type="text" inputmode="numeric" pattern="[0-9]*"></label>
      <label class="field"><span>Ink√∂psdatum</span><input id="purchaseDate" class="manual" type="date"></label>
      <label class="field"><span>Ink√∂pspris</span><input id="purchasePrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>Beg√§rt pris</span><input id="askPrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>S√•lt (betalt pris)</span><input id="paidPrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>Antal</span><input id="stockQty" class="manual" type="number" step="1" value="1"></label>
    </div>
  </div>

  <div id="badge" class="badge">Init‚Ä¶</div>
  <div id="badge2" class="badge-left">JS?</div>
  <div id="log"></div>

  <!-- Scanner overlay (live) -->
  <div id="scanOverlay" class="overlay">
    <div class="scan-card">
      <div class="scan-head">
        <strong>Live ‚Äì normalkamera (native)</strong>
        <div class="row">
          <button class="btn" id="btnTorch" style="display:none;">üí° Lampa</button>
          <button class="btn danger" id="btnStopScan">St√§ng</button>
        </div>
      </div>
      <video id="video" class="scan-video" autoplay muted playsinline></video>
      <div class="row">
        <span id="camInfo" class="note"></span>
        <span id="scanStatus" class="status"></span>
      </div>
    </div>
  </div>

  <!-- Photo input (failsafe) -->
  <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none;">

  <script>
  (function(){
    "use strict";
    const $=(s,r=document)=>r.querySelector(s);
    const logEl=$('#log'); function log(m){ const ts=new Date().toLocaleTimeString(); logEl.textContent = `[${ts}] ${m}\n` + logEl.textContent; }
    function setBadge(msg){ const b=$('#badge'); if(b) b.textContent=msg; }
    function setBadge2(msg){ const b=$('#badge2'); if(b) b.textContent=msg; }
    window.onerror = (m)=>{ setBadge2('JS-fel: '+m); log('JS-fel: '+m); };

    // Capability check
    const hasBD = 'BarcodeDetector' in window;
    let supported = [];
    if (hasBD && window.BarcodeDetector.getSupportedFormats){
      BarcodeDetector.getSupportedFormats().then(f=>{ supported=f; log('BarcodeDetector formats: '+f.join(', ')); });
    } else if (hasBD){
      log('BarcodeDetector finns men getSupportedFormats saknas');
    } else {
      log('BarcodeDetector saknas ‚Äì Live kr√§ver Chrome/Edge p√• Android med HTTPS');
    }

    // State
    let detector=null, lastStream=null, rafId=null, torchOn=false;
    let decodeCount=0, missCount=0;

    function ensureDetector(){
      if (!hasBD) return null;
      if (!detector){
        try{
          detector = new BarcodeDetector({ formats: ['ean-13','ean-8','upc-a','upc-e'] });
        }catch(e){
          log('Kunde inte skapa detector: '+(e.message||e));
          detector = null;
        }
      }
      return detector;
    }

    function supportsTorch(){
      try{
        const track = lastStream?.getVideoTracks?.()[0];
        const caps = track?.getCapabilities?.();
        return !!(caps && 'torch' in caps);
      }catch(_){ return false; }
    }
    async function setTorch(on){
      try{
        const track=lastStream.getVideoTracks()[0];
        await track.applyConstraints({ advanced:[{ torch: !!on }] });
        torchOn=!!on; updateTorchBtn();
      }catch(e){ log('Torch misslyckades: '+(e.message||e)); }
    }
    function updateTorchBtn(){
      const btn=$('#btnTorch'); if (!btn) return;
      if (supportsTorch()){ btn.style.display=''; btn.textContent = torchOn ? 'üí° Lampa AV' : 'üí° Lampa P√Ö'; btn.onclick = ()=> setTorch(!torchOn); }
      else btn.style.display='none';
    }

    function scanStatus(){ const s=$('#scanStatus'); if(s) s.textContent=`r:${decodeCount} ‚Ä¢ nf:${missCount}`; }

    function stopLive(){
      cancelAnimationFrame(rafId); rafId=null;
      if (lastStream){ try{ lastStream.getTracks().forEach(t=>t.stop()); }catch(_){ } lastStream=null; }
      $('#scanOverlay').style.display='none';
      setBadge2('JS laddat ‚úÖ (v8.7)');
      log('Live stoppad');
    }

    async function startLive(){
      if (!hasBD){ alert('Din webbl√§sare saknar Native BarcodeDetector. Prova ‚ÄúFoto (failsafe)‚Äù.'); return; }
      ensureDetector();
      try{
        $('#scanOverlay').style.display='flex';
        decodeCount=0; missCount=0; scanStatus(); log('Startar live‚Ä¶');

        // Environment, 1280x720, 16:9
        const constraints = {
          video: {
            facingMode: { ideal: 'environment' },
            width:      { ideal: 1280 },
            height:     { ideal: 720 },
            aspectRatio:{ ideal: 16/9 },
            frameRate:  { ideal: 30 },
            advanced:   [{ focusMode: 'continuous' }]
          },
          audio: false
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        const track = stream.getVideoTracks()[0];
        const s = track.getSettings ? track.getSettings() : {};
        const label = track.label || 'Kamera';
        $('#camInfo').textContent = `${label} ${s.width||''}x${s.height||''} ${s.facingMode||''}`;
        updateTorchBtn();

        const video = $('#video');
        video.srcObject = stream; lastStream = stream;
        await video.play();

        // Canvas f√∂r detektion
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        function loop(){
          rafId = requestAnimationFrame(loop);
          if (video.readyState < 2) return; // inte redo
          const vw = video.videoWidth, vh = video.videoHeight;
          if (!vw || !vh) return;
          if (canvas.width !== vw || canvas.height !== vh){
            canvas.width = vw; canvas.height = vh;
          }
          // rita aktuell frame
          ctx.drawImage(video, 0, 0, vw, vh);
          detector.detect(canvas).then(codes=>{
            if (codes && codes.length){
              // v√§lj f√∂rsta EAN/UPC
              const c = codes.find(x=>x.rawValue) || codes[0];
              if (c && c.rawValue){
                decodeCount++; scanStatus();
                const ean = String(c.rawValue).replace(/[^0-9X]/g,'');
                if ($('#ean')) $('#ean').value = ean;
                stopLive();
              }
            } else {
              missCount++; if (missCount % 25 === 0) scanStatus();
            }
          }).catch(err=>{
            log('Detect-fel: '+(err.message||err));
          });
        }
        loop();

      }catch(e){
        log('Startfel: '+(e.name||'')+' '+(e.message||e));
        if (e.name === 'NotAllowedError'){
          alert('Kameratillst√•nd beh√∂vs. √ñppna Sajtinst√§llningar ‚Üí Kamera ‚Üí Till√•t.');
        }else if (e.name === 'NotFoundError'){
          alert('Ingen kamera hittades. Kontrollera att ingen annan app anv√§nder kameran.');
        }else if (location.protocol !== 'https:'){
          alert('Live-skanning kr√§ver HTTPS. Anv√§nd https://‚Ä¶');
        }else{
          alert('Kunde inte starta kameran.');
        }
        stopLive();
      }
    }

    // Photo fallback (native BD)
    const fileInput = $('#fileInput');
    async function startPhoto(){
      try{
        fileInput.value='';
        fileInput.click();
      }catch(e){
        log('Foto-startfel: '+(e.message||e));
      }
    }
    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      log('Foto valt: '+file.type+' '+file.size+' bytes');
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = async ()=>{
        try{
          ensureDetector();
          if (!detector){ alert('Detektorn saknas i den h√§r webbl√§saren.'); return; }
          const off = document.createElement('canvas');
          off.width = img.naturalWidth; off.height = img.naturalHeight;
          const ictx = off.getContext('2d', { willReadFrequently: true });
          ictx.drawImage(img, 0, 0);
          const codes = await detector.detect(off);
          if (codes && codes.length){
            const c = codes.find(x=>x.rawValue) || codes[0];
            const ean = String(c.rawValue).replace(/[^0-9X]/g,'');
            if ($('#ean')) $('#ean').value = ean;
            log('TR√ÑFF i foto: '+ean);
          } else {
            alert('Ingen streckkod hittades i fotot. F√∂rs√∂k igen med b√§ttre fokus/ljus.');
          }
        }catch(err){
          log('Dekodfel i foto: '+(err.message||err));
          alert('Kunde inte l√§sa koden i fotot.');
        }finally{
          URL.revokeObjectURL(url);
        }
      };
      img.onerror = ()=>{ URL.revokeObjectURL(url); log('Kunde inte l√§sa bilden'); };
      img.src = url;
    });

    // Bind UI
    document.addEventListener('DOMContentLoaded', ()=>{
      $('#btnScanLive').addEventListener('click', startLive);
      $('#btnStopScan').addEventListener('click', stopLive);
      $('#btnScanPhoto').addEventListener('click', startPhoto);
      setBadge2('JS laddat ‚úÖ (v8.7)');
      log('JS laddat. Native BarcodeDetector: '+(hasBD?'Ja':'Nej') + (location.protocol!=='https:'?' ‚Ä¢ OBS! HTTPS kr√§vs f√∂r live':'') );
    });
  })();
  </script>
</body>
</html>
