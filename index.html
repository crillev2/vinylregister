<script>
/* ===== VR FIX v8 – storage-migrering + auto-add + force-render ===== */
(function(){ 'use strict';
  const KEY = 'vinyl_records';
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const n  = v => Number(v||0)||0;

  /* --- Badge: visar antal + lagringsstatus --- */
  let badge;
  function setBadge(cnt, ok){
    if(!badge){
      badge=document.createElement('div');
      Object.assign(badge.style,{position:'fixed',left:'12px',bottom:'12px',background:'#F0FFF5',border:'1px solid #9ad27e',padding:'4px 8px',borderRadius:'6px',fontSize:'12px',zIndex:99999});
      document.body.appendChild(badge);
    }
    badge.textContent = `VR v8 • ${cnt} poster • ${ok?'✅ lagring':'⚠️ ingen lagring'}`;
    clearTimeout(setBadge._t); setBadge._t=setTimeout(()=>badge&&badge.remove(), 5000);
  }

  /* --- Kan vi skriva till localStorage? --- */
  function storageOK(){
    try{ localStorage.setItem('__vr_test__','1'); localStorage.removeItem('__vr_test__'); return true; }
    catch(e){ return false; }
  }

  /* --- Läs/Spara --- */
  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(_){ return []; }
  }
  function save(arr){
    try{ localStorage.setItem(KEY, JSON.stringify(arr)); }
    catch(_){ /* ignore */ }
  }

  /* --- Migrera från ev. gamla nycklar till KEY (utan att radera dem) --- */
  function migrateKeys(){
    if (!storageOK()) return 0;
    let merged = load();
    try{
      for (let i=0; i<localStorage.length; i++){
        const k = localStorage.key(i);
        if (!k || k===KEY) continue;
        // bara rimliga kandidater
        if (!/vinyl|record|skiva|register/i.test(k)) continue;
        try{
          const arr = JSON.parse(localStorage.getItem(k) || '[]');
          if (Array.isArray(arr) && arr.length){
            // lägg in poster som inte redan finns (EAN+artist+title)
            arr.forEach(rec=>{
              if (!rec) return;
              const hit = merged.find(r=> r && r.ean===rec.ean && r.artist===rec.artist && r.title===rec.title);
              if (!hit) merged.push(rec);
            });
          }
        }catch(_){}
      }
      save(merged);
    }catch(_){}
    return Array.isArray(merged) ? merged.length : 0;
  }

  /* --- Se till att register-tabellen finns --- */
  function ensureRegister(){
    let wrap = $('#register');
    if(!wrap){
      wrap = document.createElement('div');
      wrap.id='register'; wrap.className='wrap';
      wrap.innerHTML = `<h2>Register</h2>
        <input id="quickSearch" class="manual-field" type="search" placeholder="Sök artist/titel/EAN…">
        <div class="table-wrap">
          <table id="registerTable"><thead><tr>
            <th>Bild</th><th>Artist</th><th>Album</th><th>År</th><th>Format</th>
            <th data-col="ean" class="col-ean">EAN</th><th class="right">Dagar</th>
            <th class="right">Inköp</th><th class="right">Sålt</th><th class="right">Marginal</th><th class="right">Åtgärd</th>
          </tr></thead><tbody></tbody></table>
        </div>`;
      document.body.appendChild(wrap);
    }
    const tbl = $('#registerTable');
    if (tbl && !tbl.tBodies.length) tbl.appendChild(document.createElement('tbody'));
  }

  /* --- Av-göm allt under register (utom EAN-kolumnen) --- */
  function unhide(){
    const root = $('#register'); if(!root) return;
    root.querySelectorAll('[style*="display"]').forEach(el=>{
      if(!el.classList.contains('col-ean')) el.style.removeProperty('display');
    });
    root.querySelectorAll('[hidden]').forEach(el=> el.hidden=false);
    root.querySelectorAll('tr[style*="visibility"]').forEach(el=> el.style.removeProperty('visibility'));
  }

  function daysBetween(a,b){ a=new Date(a); b=new Date(b); if(isNaN(a)||isNaN(b)) return ''; return Math.floor((b-a)/86400000); }

  /* --- Rendera tabellen robust --- */
  function render(){
    ensureRegister(); unhide();
    const ok = storageOK();
    const tb = $('#registerTable tbody'); if(!tb){ setBadge(0, ok); return; }

    const list = load();
    setBadge(list.length, ok);

    // Rensa ev. sökfilter som döljer allt
    const qs = $('#quickSearch'); if (qs && qs.value) qs.value = '';

    tb.innerHTML = '';
    const today = new Date();
    for (const rec of list){
      const tr = document.createElement('tr');
      const dgl = rec.purchaseDate ? daysBetween(rec.purchaseDate, today) : '';
      const margin = (n(rec.paidPrice)&&n(rec.purchasePrice)) ? (n(rec.paidPrice)-n(rec.purchasePrice)) : '';
      const img = rec.thumbUrl ? `<img src="${rec.thumbUrl}" class="vr-thumb" alt="" onerror="this.remove()">` : '';
      tr.innerHTML = `
        <td>${img}</td>
        <td>${rec.artist||''}</td>
        <td>${rec.title||''}</td>
        <td>${rec.year||''}</td>
        <td>${rec.format||''}</td>
        <td class="col-ean">${rec.ean||''}</td>
        <td class="right">${dgl}</td>
        <td class="right">${rec.purchasePrice||''}</td>
        <td class="right">${rec.paidPrice||''}</td>
        <td class="right">${margin}</td>
        <td class="right">—</td>`;
      tb.appendChild(tr);
    }

    // Göm EAN-kolumnen
    const tbl = tb.closest('table');
    if (tbl && tbl.tHead){
      const idx = Array.from(tbl.tHead.rows[0].cells)
        .findIndex(th => th.getAttribute('data-col')==='ean' || (th.textContent||'').trim().toLowerCase()==='ean');
      if (idx>=0){
        tbl.tHead.rows[0].cells[idx].classList.add('col-ean');
        Array.from(tb.rows).forEach(r=> r.cells[idx] && r.cells[idx].classList.add('col-ean'));
      }
    }
  }
  window.renderRegisterTable = render;

  /* --- Bygg post från fälten --- */
  function buildFromForm(){
    const get=id=> (document.getElementById(id)||document.querySelector(`[name="${id}"]`))?.value?.trim()||'';
    const img=$('#thumb'); const url=(img && img.src && !/^(?:data:)?$/i.test(img.src)) ? img.src : '';
    return {
      id:(crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now()),
      artist:get('artist')||$('#scan-artist')?.textContent||'',
      title:get('album')||get('title')||$('#scan-title')?.textContent||'',
      year:get('year'),
      format:get('format'),
      ean:get('ean')||$('#scan-ean')?.textContent||'',
      purchaseDate:get('purchaseDate')||get('inkopsdatum'),
      purchasePrice:n(get('purchasePrice')),
      askPrice:n(get('askPrice')),
      paidPrice:n(get('paidPrice')),
      stockQty:n(get('stockQty'))||1,
      thumbUrl:url
    };
  }

  /* --- Auto-add när EAN + (Artist eller Album) finns (en gång per skanning) --- */
  let lastKey='';
  function autoAddIfReady(){
    if (!storageOK()) { setBadge(0, false); return; }
    const rec = buildFromForm();
    if (!(rec.ean && (rec.artist || rec.title))) return;
    const key = rec.ean+'|'+rec.artist+'|'+rec.title;
    if (key === lastKey) return;

    const list = load();
    const same = list.find(r=> r.ean===rec.ean && r.artist===rec.artist && r.title===rec.title);
    if (same){ same.stockQty = (n(same.stockQty)||0) + (n(rec.stockQty)||1); }
    else { list.push((structuredClone?structuredClone(rec):JSON.parse(JSON.stringify(rec)))); }
    save(list);
    lastKey = key;
    render();
    try{
      const t=document.createElement('div');
      t.textContent='Tillagd i register ✅';
      Object.assign(t.style,{position:'fixed',right:'12px',bottom:'12px',background:'#eef7ff',border:'1px solid #bcd',padding:'8px 12px',borderRadius:'8px',zIndex:99999});
      document.body.appendChild(t); setTimeout(()=>t.remove(),1300);
    }catch(_){}
  }

  // Lyssna på fälten där metadata hamnar
  ['ean','artist','album','title'].forEach(id=>{
    ['input','change'].forEach(evt=>{
      document.addEventListener(evt, e=>{
        if (e.target && e.target.id===id) {
          clearTimeout(autoAddIfReady._t);
          autoAddIfReady._t = setTimeout(autoAddIfReady, 200);
        }
      }, true);
    });
  });

  /* --- Koppla in Spara-knappen (om den finns) --- */
  document.addEventListener('click', e=>{
    const btn = e.target.closest('#btnSave, .btn-save, button[type="submit"], input[type="submit"]');
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();
    if (!storageOK()) { setBadge(0, false); return; }
    const list = load(); const rec = buildFromForm();
    const same = list.find(r=> r.ean===rec.ean && r.artist===rec.artist && r.title===rec.title);
    if (same){ same.stockQty = (n(same.stockQty)||0) + (n(rec.stockQty)||1); }
    else { list.push((structuredClone?structuredClone(rec):JSON.parse(JSON.stringify(rec)))); }
    save(list); render();
  }, true);

  /* --- Rendera när data ändras på något sätt --- */
  document.addEventListener('DOMContentLoaded', ()=>{
    const cnt = migrateKeys(); // få med gamla data om de låg på annan nyckel
    render();
    // extra försök (mobil/seg DOM)
    setTimeout(render, 400);
    setTimeout(render, 1200);
    setTimeout(render, 2500);
  });
  window.addEventListener('storage', e=>{ if(e.key===KEY) render(); });
  try{
    const _set = localStorage.setItem.bind(localStorage);
    localStorage.setItem = function(k,v){
      const r = _set(k,v);
      // Om någon lägger på annan nyckel med "vinyl|record" → kopiera till KEY
      if (/vinyl|record|skiva|register/i.test(k) && k!==KEY){
        try{
          const cand = JSON.parse(v||'[]');
          if (Array.isArray(cand)) {
            const base = load();
            cand.forEach(rec=>{
              if (!rec) return;
              const hit = base.find(r=> r && r.ean===rec.ean && r.artist===rec.artist && r.title===rec.title);
              if (!hit) base.push(rec);
            });
            save(base);
          }
        }catch(_){}
      }
      if (k === KEY) { try{ render(); }catch(_){ } }
      return r;
    };
  }catch(_){}

  /* --- Dölj trasig omslagsikon i metadata-rutan --- */
  const thumb = document.getElementById('thumb');
  if (thumb){
    thumb.addEventListener('error', ()=>{ thumb.removeAttribute('src'); thumb.style.display='none'; }, {once:false});
  }
})();
</script>
