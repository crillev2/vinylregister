<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vinylregister – Färsk index</title>
  <style>
    :root { --fg:#111; --muted:#666; --line:#e5e5e5; --bg:#fff; --chip:#f6f6f6; }
    * { box-sizing: border-box; }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--fg); background:var(--bg); margin:16px; }
    h1{ margin: 0 0 12px; }
    .vr-nav{ display:flex; gap:8px; align-items:center; margin:8px 0 16px; }
    .vr-btn{ border:1px solid var(--line); border-radius:12px; padding:8px 12px; background:var(--chip); cursor:pointer; }
    .vr-btn:hover{ background:#eee; }
    .metadata-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin:12px 0 16px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field span{ font-size:0.9rem; color:var(--muted); }
    .manual-field{ background:#f8fbff; border:1px solid #dbe7ff; border-radius:8px; padding:8px; }
    .manual-field:focus{ outline:2px solid #9ec5ff; background:#fff; }
    .row-actions{ display:flex; gap:8px; justify-content:flex-end; }
    .vr-thumb{ width:48px; height:48px; object-fit:cover; border-radius:6px; border:1px solid #ddd; }
    .wrap{ border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    .muted{ color:var(--muted); }
    .table-wrap{ border:1px solid var(--line); border-radius:12px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:10px; border-bottom:1px solid #f0f0f0; text-align:left; }
    th{ background:#fafafa; }
    td.right, th.right{ text-align:right; }
    .col-ean{ display:none !important; } /* döljer EAN-kolumnen */
    #quickSearch{ width:100%; margin:8px 0 12px; }
    @media (max-width: 900px){ .metadata-grid{ grid-template-columns:1fr; } }
  </style>
  <!-- Fallback: göm EAN även utan JS (EAN är kolumn 6) -->
  <style>
    table:has(th[data-col="ean"]) th[data-col="ean"],
    table:has(th[data-col="ean"]) tbody td:nth-child(6) { display:none !important; }
  </style>
</head>
<body>

  <nav class="vr-nav">
    <button class="vr-btn" onclick="location.href='#register'">Register</button>
    <button class="vr-btn" onclick="location.href='rapport.html'">Rapport</button>
  </nav>

  <h1>Vinylregister</h1>

  <div class="wrap">
    <h2>Metadata</h2>
    <div class="metadata-grid" id="vr-meta">
      <label class="field"><span>Artist</span><input id="artist" class="manual-field" type="text" placeholder="Ex. Deep Purple"></label>
      <label class="field"><span>Album</span><input id="album" class="manual-field" type="text" placeholder="Ex. Burn"></label>
      <label class="field"><span>År</span><input id="year" class="manual-field" type="number" step="1"></label>
      <label class="field"><span>Format</span><input id="format" class="manual-field" type="text" placeholder="LP/EP/12&quot;"></label>
      <label class="field"><span>EAN</span><input id="ean" class="manual-field" type="text" placeholder="Streckkod"></label>
      <label class="field"><span>Inköpsdatum</span><input id="purchaseDate" class="manual-field" type="date"></label>
      <label class="field"><span>Inköpspris</span><input id="purchasePrice" class="manual-field" type="number" step="1"></label>
      <label class="field"><span>Begärt pris</span><input id="askPrice" class="manual-field" type="number" step="1"></label>
      <label class="field"><span>Antal</span><input id="stockQty" class="manual-field" type="number" step="1" value="1"></label>
      <label class="field"><span>Omslag</span><img id="thumb" class="vr-thumb" alt="cover"></label>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="vr-btn" id="btnSave">Spara</button>
      <span class="muted">Tips: öppna sidan med <code>?demo=1</code> för testposter.</span>
    </div>
  </div>

  <div class="wrap" id="register">
    <h2>Register</h2>
    <input id="quickSearch" class="manual-field" type="search" placeholder="Sök artist/titel/EAN…">
    <div class="table-wrap">
      <table id="registerTable">
        <thead>
          <tr>
            <th>Bild</th>
            <th>Artist</th>
            <th>Album</th>
            <th>År</th>
            <th>Format</th>
            <th data-col="ean" class="col-ean">EAN</th>
            <th class="right">Dagar</th>
            <th class="right">Inköp</th>
            <th class="right">Sålt</th>
            <th class="right">Marginal</th>
            <th class="right">Åtgärd</th>
          </tr>
        </thead>
        <tbody><!-- renderas av JS --></tbody>
      </table>
    </div>
  </div>

  <!-- === ALL-IN-ONE skript (render, spara, EAN-dölj, snabbsök, demo) === -->
  <script>
  (function(){
    "use strict";

    /* kvitto att rätt fil körs */
    try{
      const tag = document.createElement('div');
      tag.textContent = "Ny index aktiv";
      Object.assign(tag.style, {position:'fixed',left:'12px',bottom:'12px',background:'#F0FFF5',border:'1px solid #9ad27e',padding:'4px 8px',borderRadius:'6px',fontSize:'12px',zIndex:99999});
      document.body.appendChild(tag);
      setTimeout(()=>tag.remove(), 1200);
    }catch(e){}

    const $  = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const n  = v => Number(v||0)||0;

    function daysBetween(d1, d2){
      const a = (d1 instanceof Date) ? d1 : new Date(d1);
      const b = (d2 instanceof Date) ? d2 : new Date(d2);
      if(isNaN(a) || isNaN(b)) return "";
      return Math.floor(Math.abs(b-a)/(1000*60*60*24));
    }

    function loadList(){
      try{
        const raw = localStorage.getItem("vinyl_records");
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(_){ return []; }
    }
    function saveList(list){
      try{ localStorage.setItem("vinyl_records", JSON.stringify(list)); }catch(_){}
    }

    function renderRegisterTable(){
      const tb = $("#registerTable tbody");
      if(!tb) return;
      const list = loadList();
      tb.innerHTML = "";
      const today = new Date();

      list.forEach(rec=>{
        const tr = document.createElement("tr");
        const dgl = rec.purchaseDate ? daysBetween(rec.purchaseDate, today) : "";
        const margin = (n(rec.paidPrice) && n(rec.purchasePrice)) ? (n(rec.paidPrice)-n(rec.purchasePrice)) : "";

        tr.innerHTML = \`
          <td>\${ rec.thumbUrl ? \`<img src="\${rec.thumbUrl}" class="vr-thumb" alt="">\` : "" }</td>
          <td>\${ rec.artist||"" }</td>
          <td>\${ rec.title||"" }</td>
          <td>\${ rec.year||"" }</td>
          <td>\${ rec.format||"" }</td>
          <td class="col-ean">\${ rec.ean||"" }</td>
          <td class="right">\${ dgl }</td>
          <td class="right">\${ rec.purchasePrice||"" }</td>
          <td class="right">\${ rec.paidPrice||"" }</td>
          <td class="right">\${ margin }</td>
          <td class="right">—</td>
        ";
        tb.appendChild(tr);
      });

      hideEANColumn();
    }

    function hideEANColumn(){
      const tbl = $("#registerTable");
      if(!tbl || !tbl.tHead || !tbl.tHead.rows.length) return;
      const headers = Array.from(tbl.tHead.rows[0].cells);
      let idx = headers.findIndex(th => th.getAttribute("data-col")==="ean" || (th.textContent||"").trim().toLowerCase()==="ean");
      if(idx<0) return;
      headers[idx].classList.add("col-ean");
      Array.from(tbl.tBodies).forEach(tbody=>{
        Array.from(tbody.rows).forEach(tr=>{
          const c = tr.cells[idx];
          if(c) c.classList.add("col-ean");
        });
      });
    }

    function buildRecordFromForm(){
      return {
        id: (crypto&&crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
        artist: $("#artist")?.value?.trim() || "",
        title:  $("#album")?.value?.trim()  || "",
        year:   $("#year")?.value || "",
        format: $("#format")?.value || "",
        ean:    $("#ean")?.value || "",
        purchaseDate: $("#purchaseDate")?.value || "",
        purchasePrice: n($("#purchasePrice")?.value),
        askPrice:      n($("#askPrice")?.value),
        paidPrice:     n($("#paidPrice")?.value),
        stockQty:      n($("#stockQty")?.value) || 1,
        thumbUrl: $("#thumb")?.src || ""
      };
    }

    function mergeOrPush(list, rec){
      const same = list.find(r => r && r.ean && rec.ean && r.ean===rec.ean && r.artist===rec.artist && r.title===rec.title);
      if (same){ same.stockQty = (n(same.stockQty) + (rec.stockQty||1)); return list; }
      const clone = (structuredClone ? structuredClone(rec) : JSON.parse(JSON.stringify(rec)));
      list.push(clone);
      return list;
    }

    function wireSave(){
      const btn = $("#btnSave");
      if(!btn) return;
      btn.addEventListener("click", function(ev){
        ev.preventDefault();
        const rec = buildRecordFromForm();
        const list = loadList();
        mergeOrPush(list, rec);
        saveList(list);
        renderRegisterTable();
        try{
          const note = document.createElement("div");
          note.textContent = "Sparat ✅";
          Object.assign(note.style,{position:"fixed",right:"12px",bottom:"12px",background:"#eef7ff",border:"1px solid #bcd",padding:"8px 12px",borderRadius:"8px",zIndex:99999});
          document.body.appendChild(note); setTimeout(()=>note.remove(), 1200);
        }catch(_){}
      });
    }

    function wireSearch(){
      const box = $("#quickSearch");
      const tb  = $("#registerTable tbody");
      if(!box || !tb) return;
      box.addEventListener("input", function(){
        const q = this.value.toLowerCase();
        tb.querySelectorAll("tr").forEach(tr=>{
          tr.style.display = tr.textContent.toLowerCase().includes(q) ? "" : "none";
        });
      });
    }

    function installDemoIfRequested(){
      const params = new URLSearchParams(location.search);
      if(!params.has("demo")) return;
      const demo = [
        { id:"1", artist:"Deep Purple", title:"Burn", year:"1974", format:"LP", ean:"123", purchaseDate:"2025-06-01", purchasePrice:80, askPrice:120, paidPrice:100, stockQty:1, thumbUrl:"" },
        { id:"2", artist:"Led Zeppelin", title:"IV", year:"1971", format:"LP", ean:"456", purchaseDate:"2025-04-10", purchasePrice:120, askPrice:180, paidPrice:0, stockQty:1, thumbUrl:"" },
        { id:"3", artist:"Dire Straits", title:"Sultans of Swing", year:"1978", format:"7\"", ean:"789", purchaseDate:"2025-03-15", purchasePrice:40, askPrice:90, paidPrice:0, stockQty:3, thumbUrl:"" }
      ];
      saveList(demo);
    }

    document.addEventListener("DOMContentLoaded", function(){
      installDemoIfRequested();
      wireSave();
      wireSearch();
      renderRegisterTable();
    });

    if(window.MutationObserver){
      new MutationObserver(()=> hideEANColumn())
        .observe(document.body, {childList:true, subtree:true});
    }
  })();
  </script>

</body>
</html>
