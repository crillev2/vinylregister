<!-- === HOTFIX v4 – flytt av prisfält + säkert spar + sista-minuten-korrigering === -->
<script>
(function(){
  "use strict";

  /* kvitto att rätt hotfix kör */
  try{
    const tag = document.createElement('div');
    tag.textContent = "Patch v4 aktiv";
    Object.assign(tag.style,{position:'fixed',left:'12px',bottom:'12px',background:'#F0FFF5',border:'1px solid #9ad27e',padding:'4px 8px',borderRadius:'6px',fontSize:'12px',zIndex:99999});
    document.body.appendChild(tag); setTimeout(()=>tag.remove(),1500);
  }catch(e){}

  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const n  = v => Number(v||0)||0;

  /* === 1) Flytta/ skapa prisfält i metadata före tabellen === */
  function getRegisterTable(){
    return $("#registerTable") || $$("table").find(t=>{
      const ths = t.tHead ? Array.from(t.tHead.rows[0].cells).map(c=>(c.textContent||"").toLowerCase()) : [];
      return ths.includes("artist") && (ths.includes("album") || ths.includes("titel"));
    });
  }
  function ensureMetaSectionAndMoveFields(){
    const tbl = getRegisterTable(); if(!tbl) return;
    let host = $("#vr-meta"); if(!host){ host=document.createElement("div"); host.id="vr-meta"; host.className="metadata-grid"; tbl.parentNode.insertBefore(host,tbl); }

    function moveOrCreate(id,label,type){
      let input = document.getElementById(id) || document.querySelector(`[name="${id}"]`);
      let wrap = input && input.closest && input.closest("label.field");
      if(!wrap){ wrap=document.createElement("label"); wrap.className="field"; const span=document.createElement("span"); span.textContent=label; wrap.appendChild(span); }
      if(!input){ input=document.createElement("input"); input.id=id; input.name=id; input.type=type; if(type==="number") input.step="1"; }
      input.classList.add("manual-field");
      if(!host.contains(wrap)) host.appendChild(wrap);
      if(!wrap.contains(input)) wrap.appendChild(input);
    }
    moveOrCreate("purchasePrice","Inköpspris","number");
    moveOrCreate("askPrice","Begärt pris","number");
    moveOrCreate("purchaseDate","Inköpsdatum","date");
    const paid = document.getElementById("paidPrice") || document.querySelector('[name="paidPrice"]');
    if(paid){ let w=paid.closest("label.field"); if(!w){ w=document.createElement("label"); w.className="field"; const s=document.createElement("span"); s.textContent="Faktiskt betalt"; w.appendChild(s); } if(!host.contains(w)) host.appendChild(w); if(!w.contains(paid)) w.appendChild(paid); paid.classList.add("manual-field"); }

    /* städa ev. dubletter under tabellen */
    let el = tbl.nextElementSibling;
    while(el){
      ["purchasePrice","askPrice","paidPrice","purchaseDate"].forEach(id=>{
        const stray = el.querySelector && (el.querySelector("#"+id) || el.querySelector(`[name="${id}"]`));
        if(stray){ const w = stray.closest && stray.closest("label.field"); if(w && !host.contains(w)) w.remove(); else if(!host.contains(stray)) stray.remove(); }
      });
      el = el.nextElementSibling;
    }
  }

  /* === 2) Läs fält från skärmen & bygg post === */
  function getVal(...ids){
    for(const id of ids){ const el=document.getElementById(id)||document.querySelector(`[name="${id}"]`); if(el && (el.value??"")!=="") return el.value; }
    return "";
  }
  function getText(...sels){
    for(const s of sels){ const el=document.querySelector(s); if(el && (el.textContent??"")!=="") return el.textContent; }
    return "";
  }
  function getThumb(){ const el=$("#thumb")||$(".thumb img")||$("img[data-role='thumb']"); return el?el.src:""; }

  function buildRecordFromDOM(){
    return {
      id: (crypto&&crypto.randomUUID)? crypto.randomUUID() : String(Date.now()),
      artist: getVal("artist","Artist") || getText("#scan-artist"),
      title:  getVal("album","title","Album","Titel") || getText("#scan-title"),
      year:   getVal("year","År"),
      format: getVal("format","Format"),
      ean:    getVal("ean","EAN","barcode") || getText("#scan-ean"),
      purchaseDate: getVal("purchaseDate","inkopsdatum","Inköpsdatum"),
      purchasePrice: n(getVal("purchasePrice")),
      askPrice:      n(getVal("askPrice")),
      paidPrice:     n(getVal("paidPrice")),
      stockQty:      n(getVal("stockQty","antal")) || 1,
      thumbUrl: getThumb()
    };
  }

  /* === 3) Datalager & merge (vill du aldrig slå ihop: sätt ALWAYS_NEW=true) === */
  const ALWAYS_NEW = false; // sätt true om du ALLTID vill ha en ny rad även med samma EAN/artist/titel
  function loadList(){ try{ const raw=localStorage.getItem("vinyl_records"); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr:[]; }catch(_){ return []; } }
  function saveList(list){ try{ localStorage.setItem("vinyl_records", JSON.stringify(list)); }catch(_){ } }
  function mergeOrPush(list, rec){
    if(ALWAYS_NEW){ list.push(structuredClone?structuredClone(rec):JSON.parse(JSON.stringify(rec))); return list; }
    const same = list.find(r => r && r.ean && rec.ean && r.ean===rec.ean && r.artist===rec.artist && r.title===rec.title);
    if (same){ same.stockQty = (n(same.stockQty) + (rec.stockQty||1)); return list; }
    list.push(structuredClone?structuredClone(rec):JSON.parse(JSON.stringify(rec)));
    return list;
  }

  /* === 4) Hård takeover av spara (klick, submit, Enter) === */
  const SAVE_SELECTOR = '#btnSave, .btn-save, .save, button[type="submit"], input[type="submit"], button[onclick*="save"]';
  let saving=false;
  function doSave(ev){
    if(saving) return; saving=true;
    try{
      if(ev){ ev.preventDefault(); ev.stopPropagation(); if(ev.stopImmediatePropagation) ev.stopImmediatePropagation(); }
      const rec = buildRecordFromDOM();
      const list = loadList(); mergeOrPush(list, rec); saveList(list);
      if (typeof window.renderRegisterTable === "function"){ try{ window.renderRegisterTable(); }catch(_){} }
      const note=document.createElement("div"); note.textContent="Sparat ✅";
      Object.assign(note.style,{position:"fixed",right:"12px",bottom:"12px",background:"#eef7ff",border:"1px solid #bcd",padding:"8px 12px",borderRadius:"8px",zIndex:99999});
      document.body.appendChild(note); setTimeout(()=>note.remove(),1200);
    } finally { setTimeout(()=>saving=false,50); }
  }
  document.addEventListener("click", e=>{ const b=e.target.closest(SAVE_SELECTOR); if(b) doSave(e); }, true);
  document.addEventListener("submit", e=> doSave(e), true);
  document.addEventListener("keydown", e=>{ if(e.key==="Enter"){ const f=e.target.closest("form"); if(f){ doSave(e); } } }, true);

  /* === 5) Sista-minuten-korrigering: om appen ändå sparar “fel”, rätta sista posten === */
  try{
    const _set = localStorage.setItem.bind(localStorage);
    localStorage.setItem = function(k,v){
      if(k==="vinyl_records"){
        try{
          const arr = JSON.parse(v);
          if(Array.isArray(arr) && arr.length){
            const last = arr[arr.length-1] || {};
            const now  = buildRecordFromDOM();
            // Om det som står på skärmen ser annorlunda ut → skriv över sista raden med skärm-värden
            if( (now.artist && now.artist!==last.artist) || (now.title && now.title!==last.title) || (now.ean && now.ean!==last.ean) ){
              arr[arr.length-1] = Object.assign({}, last, now);
              v = JSON.stringify(arr);
              console.warn("[v4] Korrigerade sista posten till aktuella formulärvärden");
            }
          }
        }catch(_){}
      }
      return _set(k,v);
    };
  }catch(_){}

  /* === 6) Se till att EAN-kolumnen är gömd även om JS hinner sent === */
  function hideEANColumn(){
    const tbl = getRegisterTable(); if(!tbl||!tbl.tHead||!tbl.tHead.rows.length) return;
    const headers = Array.from(tbl.tHead.rows[0].cells);
    const idx = headers.findIndex(th => th.getAttribute("data-col")==="ean" || (th.textContent||"").trim().toLowerCase()==="ean");
    if(idx<0) return;
    headers[idx].classList.add("col-ean");
    Array.from(tbl.tBodies).forEach(tb=> Array.from(tb.rows).forEach(tr=> tr.cells[idx] && tr.cells[idx].classList.add("col-ean")));
  }

  /* === 7) Körning + observationer === */
  document.addEventListener("DOMContentLoaded", function(){
    ensureMetaSectionAndMoveFields();
    hideEANColumn();
  });
  if(window.MutationObserver){
    new MutationObserver(()=>{ ensureMetaSectionAndMoveFields(); hideEANColumn(); })
      .observe(document.body,{childList:true,subtree:true});
  }
})();
</script>
