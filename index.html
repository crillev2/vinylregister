<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ZXing – Minimal skanner (known-good)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .btn{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fafafa;cursor:pointer}
    #log{font-size:12px;color:#333;white-space:pre-wrap;background:#f7f7f7;border:1px solid #eee;border-radius:8px;padding:8px}
    video{width:100%;max-width:720px;background:#000;border-radius:8px;aspect-ratio:4/3}
    .guide{position:relative;display:inline-block}
    .box{position:absolute;inset:20% 10%;border:2px solid rgba(0,255,120,.9);border-radius:8px;pointer-events:none}
    .note{font-size:12px;color:#555}
  </style>
</head>
<body>
  <h1>ZXing – Minimal skanner</h1>
  <div class="row">
    <button class="btn" id="start">Starta</button>
    <button class="btn" id="stop">Stoppa</button>
    <select id="cams" class="btn"></select>
  </div>
  <div class="guide">
    <video id="video" autoplay muted playsinline></video>
    <div class="box"></div>
  </div>
  <p class="note">Tips: Håll streckkoden i rutan. Vrid 90° om den inte läses. Bra ljus. 15–25 cm.</p>
  <div id="log"></div>

  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
  <script>
    const $=s=>document.querySelector(s);
    const log = (m)=>{ $('#log').textContent = (m? m+'\n':'') + $('#log').textContent; };
    let reader=null, deviceId=null;

    async function listCams(){
      const list = await ZXing.BrowserCodeReader.listVideoInputDevices();
      const sel = $('#cams'); sel.innerHTML='';
      list.forEach((d,i)=>{
        const o=document.createElement('option');
        o.value=d.deviceId; o.textContent=d.label||('Kamera '+(i+1));
        sel.appendChild(o);
      });
      // välj "back" om vi hittar, annars första
      const idx = list.findIndex(d=>/(back|rear|environment|main|wide|tele)/i.test(d.label));
      if (idx>=0){ sel.selectedIndex=idx; deviceId=list[idx].deviceId; } else { deviceId=list[0]?.deviceId||null; }
      sel.onchange = ()=>{ deviceId = sel.value; if(reader) start(); };
      return list;
    }

    async function start(){
      try{
        if (!reader) reader = new ZXing.BrowserMultiFormatReader(new Map([
          [ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.UPC_A, ZXing.BarcodeFormat.UPC_E]],
          [ZXing.DecodeHintType.TRY_HARDER, true]
        ]));
      }catch(_){ reader = new ZXing.BrowserMultiFormatReader(); }
      try{ reader.reset(); }catch(_){}
      log('Startar…');

      const constraints = {
        video: {
          deviceId: deviceId ? { exact: deviceId } : undefined,
          facingMode: deviceId ? undefined : { ideal:'environment' },
          width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 }
        }
      };
      try{
        await reader.decodeFromConstraints(constraints, 'video', (result, err)=>{
          if (result && result.text){
            log('TRÄFF: '+result.text);
            try{ reader.reset(); }catch(_){}
          }else if(err && !(err instanceof ZXing.NotFoundException)){
            log('Fel: '+err);
          }
        });
        setTimeout(()=>{
          const vid=$('#video');
          const stream = vid && vid.srcObject;
          const t = stream && stream.getVideoTracks ? stream.getVideoTracks()[0] : null;
          const st = t && t.getSettings ? t.getSettings() : {};
          log('Kamera: ' + (t?.label||'(okänd)') + ' '+ (st.width||'') + 'x' + (st.height||''));
        }, 400);
      }catch(e){
        log('Kunde inte starta: '+e);
      }
    }

    function stop(){
      if (!reader) return;
      try{ reader.reset(); }catch(_){}
      const v=$('#video'); const s=v.srcObject;
      if (s){ try{ s.getTracks().forEach(t=>t.stop()); }catch(_){}} v.srcObject=null;
      log('Stoppad');
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      try{
        // Få labels genom en snabb, tyst begäran
        await navigator.mediaDevices.getUserMedia({ video: { facingMode:{ideal:'environment'} } });
      }catch(_){}
      await listCams();
      $('#start').onclick = start;
      $('#stop').onclick = stop;
    });
  </script>
</body>
</html>
