<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vinylregister ‚Äì Single File + Skanner v6</title>
  <style>
    :root { --fg:#111; --muted:#555; --line:#e5e5e5; --bg:#ffffff; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); background:#fff; margin:16px; }
    h1{ margin:0 0 12px; }
    .wrap{ border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    .wrap-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field span{ font-size:.9rem; color:var(--muted); }
    input.manual{ padding:8px; border:1px solid #dbe7ff; border-radius:8px; background:#f8fbff; }
    input.manual:focus{ outline:2px solid #9ec5ff; background:#fff; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn{ border:1px solid var(--line); border-radius:10px; padding:8px 12px; background:#fafafa; cursor:pointer; }
    .btn:hover{ background:#f0f0f0; }
    .btn.primary{ border-color:#cce2ff; background:#eef6ff; }
    .btn.danger{ border-color:#f3c2c2; background:#fff5f5; }
    .btn.danger:hover{ background:#ffecec; }
    .table-wrap{ border:1px solid var(--line); border-radius:12px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:10px; border-bottom:1px solid #f0f0f0; text-align:left; }
    th{ background:#fafafa; }
    td.right, th.right{ text-align:right; }
    .col-ean{ display:none !important; } /* d√∂lj EAN-kolumnen */
    #quickSearch{ width:100%; margin:8px 0 12px; }
    .badge{ position:fixed; right:12px; bottom:12px; background:#F0FFF5; border:1px solid #9ad27e; padding:4px 8px; border-radius:6px; font-size:12px; z-index:99999; white-space:nowrap; }
    .badge-left{ position:fixed; left:12px; bottom:12px; background:#F0FFF5; border:1px solid #9ad27e; padding:4px 8px; border-radius:6px; font-size:12px; z-index:99999; white-space:nowrap; }
    .note{ font-size:12px; color:var(--muted); }
    /* Scanner overlay */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:9999; }
    .scan-card{ background:#fff; border-radius:12px; padding:12px; width:min(820px, 96vw); }
    .scan-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .scan-video-wrap{ position:relative; }
    .scan-video{ width:100%; border-radius:8px; background:#000; aspect-ratio:16/9; }
    .guides{ position:absolute; inset:0; pointer-events:none; display:grid; place-items:center; }
    .guide-box{ width:72%; height:50%; border:2px solid rgba(0,255,120,.9); border-radius:12px; box-shadow: 0 0 0 9999px rgba(0,0,0,.25) inset; }
    .scan-row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .hint{ font-size:12px; color:#666; }
    .range{ display:flex; align-items:center; gap:8px; }
    .range input[type="range"]{ width:180px; }
    .engine{ display:flex; gap:8px; align-items:center; }
    #quaggaViewport{ position:relative; width:100%; display:none; }
    #quaggaViewport video, #quaggaViewport canvas{ width:100%; border-radius:8px; }
    .mirror{ transform: scaleX(-1); }
  </style>
</head>
<body>
  <h1>Vinylregister (single-file + skanner v6)</h1>

  <div class="wrap">
    <div class="wrap-head">
      <h2>Inmatning</h2>
      <button class="btn primary" id="btnScanTop">üì∑ Skanna streckkod</button>
    </div>
    <div class="grid">
      <label class="field"><span>Artist</span><input id="artist" class="manual" type="text"></label>
      <label class="field"><span>Album</span><input id="album" class="manual" type="text"></label>
      <label class="field"><span>√Ör</span><input id="year" class="manual" type="number" step="1"></label>
      <label class="field"><span>Format</span><input id="format" class="manual" type="text"></label>
      <label class="field"><span>EAN</span><input id="ean" class="manual" type="text"></label>
      <label class="field"><span>Ink√∂psdatum</span><input id="purchaseDate" class="manual" type="date"></label>
      <label class="field"><span>Ink√∂pspris</span><input id="purchasePrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>Beg√§rt pris</span><input id="askPrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>S√•lt (betalt pris)</span><input id="paidPrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>Antal</span><input id="stockQty" class="manual" type="number" step="1" value="1"></label>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="btnSave">Spara</button>
      <button class="btn" id="btnClear">Rensa f√§lt</button>
      <span id="editHint" class="note" style="display:none;">Redigeringsl√§ge ‚Äì tryck Spara f√∂r att uppdatera posten</span>
    </div>
  </div>

  <div class="wrap" id="register">
    <h2>Register</h2>
    <input id="quickSearch" class="manual" type="search" placeholder="S√∂k artist/titel/EAN‚Ä¶">
    <div class="row" style="gap:8px; margin:6px 0;">
      <button class="btn" id="btnAddTest">‚ûï L√§gg till testpost</button>
      <button class="btn" id="btnSaveTop">Spara</button>
      <button class="btn" id="btnExport">‚¨áÔ∏è Exportera JSON</button>
      <button class="btn" id="btnImport">‚¨ÜÔ∏è Importera JSON</button>
      <button class="btn danger" id="btnReset">üßπ Nollst√§ll register</button>
      <span id="keysInfo" class="note" style="margin-left:auto;"></span>
    </div>
    <div class="table-wrap">
      <table id="registerTable">
        <thead>
          <tr>
            <th>Artist</th>
            <th>Album</th>
            <th>√Ör</th>
            <th>Format</th>
            <th data-col="ean" class="col-ean">EAN</th>
            <th class="right">Dagar</th>
            <th class="right">Ink√∂p</th>
            <th class="right">S√•lt</th>
            <th class="right">Marginal</th>
            <th class="right">√Ötg√§rd</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="badge" class="badge">Init‚Ä¶</div>
  <div id="badge2" class="badge-left">JS?</div>

  <!-- Scanner overlay -->
  <div id="scanOverlay" class="overlay">
    <div class="scan-card">
      <div class="scan-head">
        <strong>Skanna streckkod</strong>
        <div class="row">
          <div class="engine">
            <label><input type="radio" name="engine" value="auto" checked> Auto</label>
            <label><input type="radio" name="engine" value="zxing"> ZXing</label>
            <label><input type="radio" name="engine" value="quagga"> Quagga2</label>
          </div>
          <select class="btn" id="cameraSelect"></select>
          <button class="btn" id="btnCycle">Byt kamera</button>
          <div class="range" id="zoomWrap" style="display:none;">
            <span>Zoom</span><input type="range" id="zoomSlider" min="1" max="1" step="0.1" value="1"><span id="zoomVal">1√ó</span>
          </div>
          <button class="btn" id="btnTorch" style="display:none;">üí° Lampa</button>
          <button class="btn danger" id="btnStopScan">St√§ng</button>
        </div>
      </div>
      <div class="scan-video-wrap" id="zxingViewport">
        <video id="video" class="scan-video" autoplay muted playsinline></video>
        <div class="guides"><div class="guide-box"></div></div>
      </div>
      <div id="quaggaViewport"></div>
      <div class="scan-row">
        <span class="hint">Tips: Tryck p√• videon f√∂r autofokus. Anv√§nd zoom & lampa vid behov. Vrid streckkoden 90¬∞ om den inte l√§ses.</span>
        <span id="camInfo" class="note"></span>
      </div>
    </div>
  </div>

  <!-- ZXing + Quagga2 via CDN -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
  <script src="https://unpkg.com/@ericblade/quagga2@2.0.0-beta.3/dist/quagga.min.js"></script>

  <script>
  (function(){
    "use strict";
    const KEY='vinyl_records';
    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const n=v=>Number(v||0)||0;
    let editingId=null;

    const store = (function(){
      try{ localStorage.setItem('__vr_test__','1'); localStorage.removeItem('__vr_test__');
        return { label:'localStorage',
          load(){ try{ const a=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(_){ return []; } },
          save(a){ localStorage.setItem(KEY, JSON.stringify(a)); },
          clear(){ localStorage.removeItem(KEY); }
        };
      }catch(_){}
      try{ sessionStorage.setItem('__vr_test__','1'); sessionStorage.removeItem('__vr_test__');
        return { label:'sessionStorage',
          load(){ try{ const a=JSON.parse(sessionStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(_){ return []; } },
          save(a){ sessionStorage.setItem(KEY, JSON.stringify(a)); },
          clear(){ sessionStorage.removeItem(KEY); }
        };
      }catch(_){}
      let mem = [];
      return { label:'memory',
        load(){ return mem.slice(); },
        save(a){ mem = Array.isArray(a)?a.slice():[]; },
        clear(){ mem = []; }
      };
    })();

    function setBadge(msg){ const b=$('#badge'); if(b) b.textContent=msg; }
    function setBadge2(msg){ const b=$('#badge2'); if(b) b.textContent=msg; }
    function setCamInfo(msg){ const el=$('#camInfo'); if (el) el.textContent = msg || ''; }

    function daysBetween(a,b){ a=new Date(a); b=new Date(b); if(isNaN(a)||isNaN(b)) return ''; return Math.floor((b-a)/86400000); }
    function listKeysInfo(){
      const out=[]; try{ for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); const v=localStorage.getItem(k)||''; out.push('L:'+k+'('+v.length+')'); } }catch(_){}
      try{ for(let i=0;i<sessionStorage.length;i++){ const k=sessionStorage.key(i); const v=sessionStorage.getItem(k)||''; out.push('S:'+k+'('+v.length+')'); } }catch(_){}
      return out.join(' ¬∑ ');
    }
    function hideEANColumn(tbl){
      if(!tbl || !tbl.tHead || !tbl.tHead.rows.length) return;
      const idx = Array.from(tbl.tHead.rows[0].cells).findIndex(th => th.getAttribute('data-col')==='ean' || (th.textContent||'').trim().toLowerCase()==='ean');
      if(idx<0) return;
      tbl.tHead.rows[0].cells[idx].classList.add('col-ean');
      Array.from(tbl.tBodies).forEach(tbody=> Array.from(tbody.rows).forEach(tr=> tr.cells[idx] && tr.cells[idx].classList.add('col-ean')));
    }

    function render(){
      const list=store.load();
      let changed=false;
      for (let i=0;i<list.length;i++){
        if (!list[i].id){
          list[i].id = (crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now()+Math.random());
          changed=true;
        }
      }
      if (changed) store.save(list);

      setBadge(`Single-file ‚Ä¢ ${list.length} poster ‚Ä¢ Storage: ${store.label}`);
      const ki=$('#keysInfo'); if(ki) ki.textContent = 'Nycklar: ' + (listKeysInfo() || '‚Äî');

      const tb=$('#registerTable tbody'); if(!tb) return;
      tb.innerHTML='';
      const today = new Date();
      list.forEach(rec=>{
        const tr=document.createElement('tr');
        const margin=(n(rec.paidPrice)&&n(rec.purchasePrice))?(n(rec.paidPrice)-n(rec.purchasePrice)):'';
        const dgl=rec.purchaseDate?daysBetween(rec.purchaseDate,today):'';
        tr.innerHTML = `
          <td>${rec.artist||''}</td>
          <td>${rec.title||''}</td>
          <td>${rec.year||''}</td>
          <td>${rec.format||''}</td>
          <td class="col-ean">${rec.ean||''}</td>
          <td class="right">${dgl}</td>
          <td class="right">${rec.purchasePrice||''}</td>
          <td class="right">${rec.paidPrice||''}</td>
          <td class="right">${margin}</td>
          <td class="right">
            <button class="btn" data-act="edit" data-id="${rec.id}">Redigera</button>
            <button class="btn danger" data-act="del" data-id="${rec.id}">Ta bort</button>
          </td>`;
        tb.appendChild(tr);
      });
      hideEANColumn($('#registerTable'));
    }

    function buildFromForm(){
      const g=id=>($('#'+id)&&$('#'+id).value)||'';
      return {
        id: editingId || ((crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now())),
        artist: g('artist').trim(),
        title:  g('album').trim(),
        year:   g('year'),
        format: g('format'),
        ean:    g('ean'),
        purchaseDate: g('purchaseDate'),
        purchasePrice: n(g('purchasePrice')),
        askPrice:      n(g('askPrice')),
        paidPrice:     n(g('paidPrice')),
        stockQty:      n(g('stockQty')) || 1,
        thumbUrl: ''
      };
    }
    function clearForm(){
      ['artist','album','year','format','ean','purchaseDate','purchasePrice','askPrice','paidPrice','stockQty'].forEach(id=>{
        const el=$('#'+id); if(!el) return;
        el.value = (id==='stockQty')?1:'';
      });
      const eh=$('#editHint'); if(eh) eh.style.display='none';
      editingId=null;
    }

    function hookSave(){
      const rec = buildFromForm();
      const list = store.load();
      const idx = list.findIndex(r=> r.id===rec.id);
      if (idx>=0) list[idx]=rec; else list.push(rec);
      store.save(list); render(); clearForm();
    }

    // --- Skanner v6: b√§ttre kameraplock + Byt kamera ---
    let currentEngine = 'auto'; // 'zxing' | 'quagga' | 'auto'
    let codeReader = null;
    let currentDeviceId = null;
    let lastStream = null;
    let torchOn = false;
    let watchdogTimer = null;
    let wakeLock = null;
    let autoFallbackTimer = null;
    let deviceList = []; // sorterad, bakre f√∂rst
    let deviceIndex = 0;

    const HINTS = (function(){
      try{
        const hints = new Map();
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
          ZXing.BarcodeFormat.EAN_13,
          ZXing.BarcodeFormat.EAN_8,
          ZXing.BarcodeFormat.UPC_A,
          ZXing.BarcodeFormat.UPC_E
        ]);
        hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
        return hints;
      }catch(_){ return undefined; }
    })();

    function getChosenEngine(){
      const checked = $$('input[name="engine"]').find(r=> r.checked);
      return checked ? checked.value : 'auto';
    }

    function makeReader(){
      if (!codeReader){
        try{ codeReader = new ZXing.BrowserMultiFormatReader(HINTS); }
        catch(_){ codeReader = new ZXing.BrowserMultiFormatReader(); }
      }
      return codeReader;
    }

    function trackAlive(){
      if (!lastStream) return false;
      const vTracks = lastStream.getVideoTracks ? lastStream.getVideoTracks() : [];
      if (!vTracks.length) return false;
      const t = vTracks[0];
      return t.readyState === 'live' && !t.muted && !t.stopped;
    }

    async function requestWakeLock(){
      try{
        if ('wakeLock' in navigator){
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', ()=> setBadge2('Wake lock sl√§ppt'));
          setBadge2('Wake lock aktiv');
        }
      }catch(_){ /* ignore */ }
    }

    function releaseWakeLock(){
      try{ wakeLock && wakeLock.release(); }catch(_){}
      wakeLock = null;
    }

    function setupEngineSwitch(){
      $$('input[name="engine"]').forEach(radio=>{
        radio.addEventListener('change', ()=>{
          const next = getChosenEngine();
          if (next !== currentEngine){
            currentEngine = next;
            restartScannerEngine();
          }
        });
      });
    }

    function labelScore(label){
      label = (label||'').toLowerCase();
      let score = 0;
      if (/(back|rear|environment|main|wide|tele)/.test(label)) score += 10;
      if (/(front|user|selfie|face)/.test(label)) score -= 10;
      // prefer higher-numbered back cameras first (often main)
      if (/back.*\b0\b/.test(label)) score += 2;
      return score;
    }

    async function buildDeviceList(){
      const devices = await navigator.mediaDevices.enumerateDevices();
      const vids = devices.filter(d=> d.kind==='videoinput');
      vids.sort((a,b)=> labelScore(b.label)-labelScore(a.label));
      deviceList = vids;
      deviceIndex = 0;
      // v√§lj f√∂rsta som inte ser ut som front
      const idx = vids.findIndex(d=> labelScore(d.label) >= 0);
      if (idx>=0) deviceIndex = idx;
      currentDeviceId = vids[deviceIndex] ? vids[deviceIndex].deviceId : null;
      fillCameraSelect();
    }

    function fillCameraSelect(){
      const sel = $('#cameraSelect');
      sel.innerHTML='';
      deviceList.forEach((d,i)=>{
        const opt=document.createElement('option');
        opt.value=d.deviceId;
        opt.textContent = d.label || ('Kamera '+(i+1));
        sel.appendChild(opt);
      });
      if (currentDeviceId) sel.value = currentDeviceId;
      $('#btnCycle').onclick = ()=>{
        if (!deviceList.length) return;
        deviceIndex = (deviceIndex + 1) % deviceList.length;
        currentDeviceId = deviceList[deviceIndex].deviceId;
        sel.value = currentDeviceId;
        restartScannerEngine();
      };
      sel.onchange = ()=>{
        currentDeviceId = sel.value;
        deviceIndex = Math.max(0, deviceList.findIndex(d=> d.deviceId===currentDeviceId));
        restartScannerEngine();
      };
    }

    async function startScanner(){
      currentEngine = getChosenEngine();
      $('#zxingViewport').style.display = (currentEngine==='quagga') ? 'none' : '';
      $('#quaggaViewport').style.display = (currentEngine==='quagga') ? '' : 'none';
      const overlay = $('#scanOverlay');
      overlay.style.display = 'flex';
      setBadge2('Startar kamera‚Ä¶');
      setCamInfo('');

      setupEngineSwitch();
      await requestWakeLock();

      // 1) F√∂rst: f√• upp en stream med environment-√∂nskan s√• att labels blir synliga
      try{
        const pre = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal:'environment' }, width:{ideal:1920}, height:{ideal:1080} }
        });
        const v = $('#video'); v.srcObject = pre; lastStream = pre;
      }catch(_){ /* ignore, g√•r vidare √§nd√• */ }

      // 2) Nu har vi tillst√•nd ‚Üí bygg lista och v√§lj bakre kamera om m√∂jligt
      try{ await buildDeviceList(); }catch(_){}

      // 3) Starta vald motor
      await startEngine(currentEngine);

      // Auto-fallback efter 6 sek utan tr√§ff i "auto"-l√§ge
      clearTimeout(autoFallbackTimer);
      if (currentEngine==='auto'){
        autoFallbackTimer = setTimeout(()=>{
          if (overlay.style.display!=='none'){
            if ($('#zxingViewport').style.display!=='none'){
              setBadge2('Byter till Quagga2‚Ä¶');
              currentEngine = 'quagga';
              restartScannerEngine();
            }
          }
        }, 6000);
      }
    }

    async function startEngine(engine){
      if (engine==='quagga'){ await startQuagga(); }
      else { await startZXing(); }
    }

    async function restartScannerEngine(){
      await stopZXing();
      await stopQuagga();
      $('#zxingViewport').style.display = (currentEngine==='quagga') ? 'none' : '';
      $('#quaggaViewport').style.display = (currentEngine==='quagga') ? '' : 'none';
      await startEngine(currentEngine);
    }

    async function stopScanner(){
      const overlay = $('#scanOverlay');
      overlay.style.display = 'none';
      clearInterval(watchdogTimer); watchdogTimer=null;
      clearTimeout(autoFallbackTimer); autoFallbackTimer=null;
      await stopZXing();
      await stopQuagga();
      releaseWakeLock();
      setBadge2('JS laddat ‚úÖ');
    }

    function onDetectedEAN(text){
      const ean = String(text).replace(/[^0-9X]/g,'');
      if (!ean) return;
      const eanInput = $('#ean'); if (eanInput) eanInput.value = ean;
      beep();
      stopScanner();
    }

    // ---------- ZXing ----------
    function updateTorchButton(){
      const btn = $('#btnTorch');
      if (!btn) return;
      if (supportsTorch()){
        btn.style.display = '';
        btn.textContent = torchOn ? 'üí° Lampa AV' : 'üí° Lampa P√Ö';
        btn.onclick = ()=> setTorch(!torchOn);
      } else {
        btn.style.display = 'none';
      }
    }
    function supportsTorch(){
      try{
        if (!lastStream) return false;
        const track = lastStream.getVideoTracks && lastStream.getVideoTracks()[0];
        if (!track) return false;
        const caps = track.getCapabilities && track.getCapabilities();
        return !!(caps && 'torch' in caps);
      }catch(_){ return false; }
    }
    async function setTorch(on){
      try{
        if (!lastStream) return;
        const track = lastStream.getVideoTracks()[0];
        await track.applyConstraints({ advanced: [{ torch: !!on }] });
        torchOn = !!on;
        updateTorchButton();
      }catch(e){ console.warn('Torch not supported:', e); }
    }
    function setupZoom(){
      const video = $('#video');
      const track = video && video.srcObject ? video.srcObject.getVideoTracks()[0] : null;
      if (!track || !track.getCapabilities) return;
      const caps = track.getCapabilities();
      const wrap = $('#zoomWrap');
      const slider = $('#zoomSlider');
      const label = $('#zoomVal');
      if (caps.zoom){
        wrap.style.display='flex';
        slider.min = caps.zoom.min || 1;
        slider.max = caps.zoom.max || 1;
        slider.step = caps.zoom.step || 0.1;
        const s = track.getSettings && track.getSettings();
        if (s && s.zoom) slider.value = s.zoom;
        label.textContent = (Number(slider.value)||1).toFixed(1)+'√ó';
        slider.oninput = async ()=>{
          const val = Number(slider.value)||1;
          label.textContent = val.toFixed(1)+'√ó';
          try{ await track.applyConstraints({ advanced: [{ zoom: val }] }); }catch(_){}
        };
      } else {
        wrap.style.display='none';
      }
    }
    function setupTapFocus(){
      const video = $('#video');
      video.onclick = async ()=>{
        try{
          const track = video && video.srcObject ? video.srcObject.getVideoTracks()[0] : null;
          if (!track) return;
          try{ await track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); }catch(_){}
          try{ await track.applyConstraints({ advanced: [{ focusMode: 'auto' }] }); }catch(_){}
          setBadge2('Autofokus triggad');
        }catch(_){}
      };
    }

    function updateMirror(label){
      const video = $('#video');
      const isFront = /(front|user|selfie|face)/i.test(label||'');
      video.classList.toggle('mirror', isFront);
    }

    async function startZXing(){
      $('#zxingViewport').style.display='';
      $('#quaggaViewport').style.display='none';
      const reader = makeReader();
      const sel = $('#cameraSelect');

      async function restartZXing(){
        try{ reader.reset(); }catch(_){}
        torchOn = false;
        // Beg√§r 1080p
        const constraints = {
          video: {
            deviceId: currentDeviceId ? { exact: currentDeviceId } : undefined,
            facingMode: currentDeviceId ? undefined : { ideal: 'environment' },
            width:  { ideal: 1920 },
            height: { ideal: 1080 },
            aspectRatio: { ideal: 1.777 },
            frameRate: { ideal: 30 }
          }
        };
        try{
          await reader.decodeFromConstraints(constraints, 'video', (result, err) => {
            if (result && result.text){
              onDetectedEAN(result.text);
            } else if (err && !(err instanceof ZXing.NotFoundException)){
              console.warn('ZXing error:', err);
            }
          });
          setTimeout(async ()=>{
            const video = $('#video');
            lastStream = video && video.srcObject ? video.srcObject : null;
            const t = lastStream && lastStream.getVideoTracks ? lastStream.getVideoTracks()[0] : null;
            if (t){
              t.onended = ()=>{ setBadge2('ZXing: str√∂m slutade ‚Äì startar om'); restartZXing(); };
              const settings = t.getSettings ? t.getSettings() : {};
              const label = t.label || (deviceList[deviceIndex] && deviceList[deviceIndex].label) || '';
              setCamInfo(`${label} ${settings.width||''}x${settings.height||''}`);
              updateMirror(label);
            }
            setupZoom(); setupTapFocus(); updateTorchButton();
          }, 400);
        }catch(e){
          console.error(e);
          setBadge2('ZXing kunde inte starta');
        }
      }

      await restartZXing();
      startWatchdog(()=>{
        if (!trackAlive()){
          setBadge2('ZXing watchdog: startar om');
          restartZXing();
        }
      });

      sel.onchange = ()=>{
        currentDeviceId = sel.value;
        deviceIndex = Math.max(0, deviceList.findIndex(d=> d.deviceId===currentDeviceId));
        restartZXing();
      };
    }

    async function stopZXing(){
      try{ codeReader && codeReader.reset(); }catch(_){}
      if (lastStream){
        try{ lastStream.getTracks().forEach(t=>t.stop()); }catch(_){}
        lastStream = null;
      }
      stopWatchdog();
    }

    // ---------- Quagga2 ----------
    function startWatchdog(fn){
      clearInterval(watchdogTimer); watchdogTimer = setInterval(fn, 2500);
    }
    function stopWatchdog(){
      clearInterval(watchdogTimer); watchdogTimer=null;
    }

    async function startQuagga(){
      $('#zxingViewport').style.display='none';
      const target = document.getElementById('quaggaViewport');
      target.style.display='block';
      try{
        await Quagga.init({
          inputStream: {
            type: "LiveStream",
            target,
            constraints: {
              facingMode: "environment",
              deviceId: currentDeviceId || undefined,
              width: { ideal: 1920 },
              height: { ideal: 1080 }
            }
          },
          locator: { patchSize: "medium", halfSample: true },
          numOfWorkers: 0,
          frequency: 10,
          decoder: { readers: ["ean_reader","ean_8_reader","upc_reader","upc_e_reader"] },
          locate: true
        }, (err)=>{
          if (err){ console.error(err); setBadge2('Quagga init-fel'); return; }
          Quagga.start();
          setBadge2('Quagga k√∂r');
        });
      }catch(e){
        console.error(e); setBadge2('Quagga start-fel');
      }

      Quagga.offDetected();
      Quagga.onDetected(data=>{
        if (!data || !data.codeResult || !data.codeResult.code) return;
        onDetectedEAN(data.codeResult.code);
      });
    }

    async function stopQuagga(){
      try{ Quagga.stop(); }catch(_){}
      try{ Quagga.offDetected(); }catch(_){}
      const target = document.getElementById('quaggaViewport');
      target.style.display='none';
    }

    function beep(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='sine'; o.frequency.value=880;
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime+0.01);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.05); o.stop(ctx.currentTime+0.07); }, 80);
      }catch(_){}
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      setBadge2('JS laddat ‚úÖ');

      const btnSave=$('#btnSave');
      const btnSaveTop=$('#btnSaveTop');
      if (btnSave) btnSave.addEventListener('click', hookSave);
      if (btnSaveTop) btnSaveTop.addEventListener('click', hookSave);

      const btnClear=$('#btnClear'); if(btnClear) btnClear.addEventListener('click', clearForm);
      const btnAddTest=$('#btnAddTest'); if(btnAddTest) btnAddTest.addEventListener('click', ()=>{
        const list=store.load();
        list.push({
          id:(crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now()+Math.random()),
          artist:'Testartist', title:'Testalbum', year:'1979', format:'LP',
          ean:String(Math.floor(1000000000000 + Math.random()*8999999999999)),
          purchaseDate:new Date().toISOString().slice(0,10),
          purchasePrice:50, askPrice:100, paidPrice:0, stockQty:1, thumbUrl:''
        });
        store.save(list); render();
      });
      const btnExport=$('#btnExport'); if(btnExport) btnExport.addEventListener('click', ()=>{
        const blob=new Blob([JSON.stringify(store.load()||[], null, 2)], {type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='vinyl_records.json'; a.click();
      });
      const btnImport=$('#btnImport'); if(btnImport) btnImport.addEventListener('click', ()=>{
        const input=document.createElement('input'); input.type='file'; input.accept='application/json';
        input.onchange = async (e)=>{
          const file=e.target.files[0]; if(!file) return;
          const text=await file.text();
          try{ const arr=JSON.parse(text); if(!Array.isArray(arr)) throw new Error('Inte en array'); store.save(arr); render(); }
          catch(err){ alert('Ogiltig JSON: '+err.message); }
        };
        input.click();
      });
      const btnReset=$('#btnReset'); if(btnReset) btnReset.addEventListener('click', ()=>{
        if (!confirm('Nollst√§lla registret i ' + store.label + '?')) return;
        store.clear(); render();
      });
      const qs=$('#quickSearch'); if(qs) qs.addEventListener('input', function(){
        const q=this.value.toLowerCase();
        const tb=$('#registerTable tbody');
        if (!tb) return;
        tb.querySelectorAll('tr').forEach(tr=>{
          tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      });

      // Flyttad skannaknapp i headern
      const btnScanTop=$('#btnScanTop'); if(btnScanTop) btnScanTop.addEventListener('click', startScanner);
      const btnStopScan=$('#btnStopScan'); if(btnStopScan) btnStopScan.addEventListener('click', stopScanner);

      // Fallback-klick p√• video f√∂r fokus
      const video = $('#video'); if (video) video.addEventListener('click', ()=> setBadge2('Autofokus f√∂rs√∂kt'));

      document.addEventListener('click', (e)=>{
        const btn=e.target.closest('button[data-act]'); if(!btn) return;
        const id=btn.getAttribute('data-id'); const act=btn.getAttribute('data-act');
        const list=store.load();
        const idx=list.findIndex(r=> r.id===id);
        if (idx<0) return;

        if (act==='del'){
          if (!confirm('Ta bort denna post?')) return;
          list.splice(idx,1); store.save(list); render(); return;
        }
        if (act==='edit'){
          const rec=list[idx];
          const S=(id,v)=>{ const el=$('#'+id); if(el) el.value=v||''; };
          S('artist',rec.artist); S('album',rec.title); S('year',rec.year); S('format',rec.format);
          S('ean',rec.ean); S('purchaseDate',rec.purchaseDate); S('purchasePrice',rec.purchasePrice);
          S('askPrice',rec.askPrice); S('paidPrice',rec.paidPrice); S('stockQty',rec.stockQty||1);
          editingId = rec.id;
          const eh=$('#editHint'); if(eh) eh.style.display='inline-block';
          window.scrollTo({top:0, behavior:'smooth'});
        }
      }, true);

      render();
    });
  })();
  </script>
</body>
</html>
