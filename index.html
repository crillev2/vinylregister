<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vinylregister ‚Äì v8.5 (Normalkamera / environment, helbild)</title>
  <style>
    :root { --fg:#111; --muted:#555; --line:#e5e5e5; --bg:#ffffff; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); background:#fff; margin:16px; }
    h1{ margin:0 0 12px; }
    .wrap{ border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    .wrap-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field span{ font-size:.9rem; color:var(--muted); }
    input.manual{ padding:8px; border:1px solid #dbe7ff; border-radius:8px; background:#f8fbff; }
    input.manual:focus{ outline:2px solid #9ec5ff; background:#fff; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn{ border:1px solid var(--line); border-radius:10px; padding:8px 12px; background:#fafafa; cursor:pointer; }
    .btn:hover{ background:#f0f0f0; }
    .btn.primary{ border-color:#cce2ff; background:#eef6ff; }
    .btn.danger{ border-color:#f3c2c2; background:#fff5f5; }
    .btn.danger:hover{ background:#ffecec; }
    .table-wrap{ border:1px solid var(--line); border-radius:12px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:10px; border-bottom:1px solid #f0f0f0; text-align:left; }
    th{ background:#fafafa; }
    td.right, th.right{ text-align:right; }
    .col-ean{ display:none !important; } /* d√∂lj EAN-kolumnen */
    #quickSearch{ width:100%; margin:8px 0 12px; }
    .badge{ position:fixed; right:12px; bottom:12px; background:#F0FFF5; border:1px solid #9ad27e; padding:4px 8px; border-radius:6px; font-size:12px; z-index:99999; white-space:nowrap; }
    .badge-left{ position:fixed; left:12px; bottom:12px; background:#F0FFF5; border:1px solid #9ad27e; padding:4px 8px; border-radius:6px; font-size:12px; z-index:99999; white-space:nowrap; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:56px; background:#222; color:#fff; font-size:12px; padding:8px 12px; border-radius:8px; z-index:99999; opacity:.95; }
    .note{ font-size:12px; color:var(--muted); }
    /* Scanner overlay */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:9999; }
    .scan-card{ background:#fff; border-radius:12px; padding:12px; width:min(820px, 96vw); }
    .scan-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .scan-video-wrap{ position:relative; }
    .scan-video{ width:100%; border-radius:8px; background:#000; aspect-ratio:16/9; }
    .range{ display:flex; align-items:center; gap:8px; }
    .range input[type="range"]{ width:180px; }
    .status{ font-size:12px; color:#333; padding:4px 8px; background:#f5f5f5; border:1px solid #eee; border-radius:6px; }
  </style>
</head>
<body>
  <h1>Vinylregister ‚Äì v8.5 (Normalkamera / environment, helbild)</h1>

  <div class="wrap">
    <div class="wrap-head">
      <h2>Inmatning</h2>
      <button class="btn primary" id="btnScanTop" onclick="window.__startScanner && window.__startScanner()">üì∑ Skanna (normalkamera)</button>
    </div>
    <div class="grid">
      <label class="field"><span>Artist</span><input id="artist" class="manual" type="text"></label>
      <label class="field"><span>Album</span><input id="album" class="manual" type="text"></label>
      <label class="field"><span>√Ör</span><input id="year" class="manual" type="number" step="1"></label>
      <label class="field"><span>Format</span><input id="format" class="manual" type="text"></label>
      <label class="field"><span>EAN</span><input id="ean" class="manual" type="text"></label>
      <label class="field"><span>Ink√∂psdatum</span><input id="purchaseDate" class="manual" type="date"></label>
      <label class="field"><span>Ink√∂pspris</span><input id="purchasePrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>Beg√§rt pris</span><input id="askPrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>S√•lt (betalt pris)</span><input id="paidPrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>Antal</span><input id="stockQty" class="manual" type="number" step="1" value="1"></label>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="btnSave">Spara</button>
      <button class="btn" id="btnClear">Rensa f√§lt</button>
      <span id="editHint" class="note" style="display:none;">Redigeringsl√§ge ‚Äì tryck Spara f√∂r att uppdatera posten</span>
    </div>
  </div>

  <div class="wrap" id="register">
    <h2>Register</h2>
    <input id="quickSearch" class="manual" type="search" placeholder="S√∂k artist/titel/EAN‚Ä¶">
    <div class="row" style="gap:8px; margin:6px 0;">
      <button class="btn" id="btnAddTest">‚ûï L√§gg till testpost</button>
      <button class="btn" id="btnSaveTop">Spara</button>
      <button class="btn" id="btnExport">‚¨áÔ∏è Exportera JSON</button>
      <button class="btn" id="btnImport">‚¨ÜÔ∏è Importera JSON</button>
      <button class="btn danger" id="btnReset">üßπ Nollst√§ll register</button>
      <span id="keysInfo" class="note" style="margin-left:auto;"></span>
    </div>
    <div class="table-wrap">
      <table id="registerTable">
        <thead>
          <tr>
            <th>Artist</th>
            <th>Album</th>
            <th>√Ör</th>
            <th>Format</th>
            <th data-col="ean" class="col-ean">EAN</th>
            <th class="right">Dagar</th>
            <th class="right">Ink√∂p</th>
            <th class="right">S√•lt</th>
            <th class="right">Marginal</th>
            <th class="right">√Ötg√§rd</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="badge" class="badge">Init‚Ä¶</div>
  <div id="badge2" class="badge-left">JS?</div>

  <!-- Scanner overlay -->
  <div id="scanOverlay" class="overlay">
    <div class="scan-card">
      <div class="scan-head">
        <strong>Skanna ‚Äì normalkamera (helbild)</strong>
        <div class="row">
          <div class="range" id="zoomWrap" style="display:none;">
            <span>Zoom</span><input type="range" id="zoomSlider" min="1" max="1" step="0.1" value="1"><span id="zoomVal">1√ó</span>
          </div>
          <button class="btn" id="btnTorch" style="display:none;">üí° Lampa</button>
          <button class="btn danger" id="btnStopScan">St√§ng</button>
        </div>
      </div>
      <div class="scan-video-wrap">
        <video id="video" class="scan-video" autoplay muted playsinline></video>
      </div>
      <div class="row">
        <span id="camInfo" class="note"></span>
        <span id="scanStatus" class="status"></span>
      </div>
    </div>
  </div>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>

  <script>
  (function(){
    "use strict";
    // helpers
    const $=(s,r=document)=>r.querySelector(s);
    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 1600); }
    function setBadge(msg){ const b=$('#badge'); if(b) b.textContent=msg; }
    function setBadge2(msg){ const b=$('#badge2'); if(b) b.textContent=msg; }
    window.onerror = (m)=>{ setBadge2('JS-fel: '+m); toast('JS-fel: '+m); };

    // register bits
    const KEY='vinyl_records'; const n=v=>Number(v||0)||0; let editingId=null;
    const store=(function(){ try{ localStorage.setItem('__vr_test__','1'); localStorage.removeItem('__vr_test__');
      return {label:'localStorage', load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]')||[] }catch(_){ return [] }}, save(a){ localStorage.setItem(KEY, JSON.stringify(a)) }, clear(){ localStorage.removeItem(KEY) } };
    }catch(_){ let mem=[]; return { label:'memory', load(){return mem.slice()}, save(a){mem=a.slice()}, clear(){mem=[]} }; })();

    function daysBetween(a,b){ a=new Date(a); b=new Date(b); if(isNaN(a)||isNaN(b)) return ''; return Math.floor((b-a)/86400000); }
    function hideEANColumn(tbl){
      if(!tbl || !tbl.tHead || !tbl.tHead.rows.length) return;
      const idx = Array.from(tbl.tHead.rows[0].cells).findIndex(th => th.getAttribute('data-col')==='ean' || (th.textContent||'').trim().toLowerCase()==='ean');
      if(idx<0) return;
      tbl.tHead.rows[0].cells[idx].classList.add('col-ean');
      Array.from(tbl.tBodies).forEach(tbody=> Array.from(tbody.rows).forEach(tr=> tr.cells[idx] && tr.cells[idx].classList.add('col-ean')));
    }
    function render(){
      const list=store.load();
      setBadge(`Single-file ‚Ä¢ ${list.length} poster ‚Ä¢ Storage: ${store.label}`);
      const tb=$('#registerTable tbody'); if(!tb) return; tb.innerHTML='';
      const today=new Date();
      list.forEach(rec=>{
        const tr=document.createElement('tr');
        const margin=(n(rec.paidPrice)&&n(rec.purchasePrice))?(n(rec.paidPrice)-n(rec.purchasePrice)):'';
        const dgl=rec.purchaseDate?daysBetween(rec.purchaseDate,today):'';
        tr.innerHTML=`
          <td>${rec.artist||''}</td>
          <td>${rec.title||''}</td>
          <td>${rec.year||''}</td>
          <td>${rec.format||''}</td>
          <td class="col-ean">${rec.ean||''}</td>
          <td class="right">${dgl}</td>
          <td class="right">${rec.purchasePrice||''}</td>
          <td class="right">${rec.paidPrice||''}</td>
          <td class="right">${margin}</td>
          <td class="right">
            <button class="btn" data-act="edit" data-id="${rec.id}">Redigera</button>
            <button class="btn danger" data-act="del" data-id="${rec.id}">Ta bort</button>
          </td>`;
        tb.appendChild(tr);
      });
      hideEANColumn($('#registerTable'));
    }
    function buildFromForm(){
      const g=id=>($('#'+id)&&$('#'+id).value)||'';
      return { id: editingId||((crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now())),
        artist:g('artist').trim(), title:g('album').trim(), year:g('year'), format:g('format'), ean:g('ean'),
        purchaseDate:g('purchaseDate'), purchasePrice:n(g('purchasePrice')), askPrice:n(g('askPrice')), paidPrice:n(g('paidPrice')), stockQty:n(g('stockQty'))||1, thumbUrl:''
      };
    }
    function clearForm(){ ['artist','album','year','format','ean','purchaseDate','purchasePrice','askPrice','paidPrice','stockQty'].forEach(id=>{ const el=$('#'+id); if(el) el.value=(id==='stockQty')?1:''; }); editingId=null; }
    function hookSave(){ const rec=buildFromForm(); const list=store.load(); const idx=list.findIndex(r=>r.id===rec.id); if(idx>=0) list[idx]=rec; else list.push(rec); store.save(list); render(); clearForm(); }

    // --- Skanner v8.5: Normalkamera (environment) ONLY ---
    let codeReader=null, lastStream=null, watchdogTimer=null, decodeCount=0, notFoundCount=0;
    let envDevice=null, torchOn=false;

    function makeReader(){
      if (!codeReader){
        try{
          const hints=new Map();
          hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.UPC_A, ZXing.BarcodeFormat.UPC_E]);
          hints.set(ZXing.DecodeHintType.TRY_HARDER,true);
          codeReader=new ZXing.BrowserMultiFormatReader(hints);
        }catch(_){ codeReader=new ZXing.BrowserMultiFormatReader(); }
      }
      return codeReader;
    }
    function trackAlive(){
      if (!lastStream) return false;
      const vTracks=lastStream.getVideoTracks?lastStream.getVideoTracks():[];
      if (!vTracks.length) return false;
      const t=vTracks[0];
      return t.readyState==='live'&&!t.muted&&!t.stopped;
    }
    function labelScore(label){
      label=(label||'').toLowerCase();
      let s=0;
      if (/(back|rear|environment|main)/.test(label)) s+=10;
      if (/(wide|tele|main)/.test(label)) s+=2;
      if (/(front|user|selfie|face)/.test(label)) s-=50;
      return s;
    }
    async function pickEnvironmentCamera(){
      const devices=await navigator.mediaDevices.enumerateDevices();
      const vids=devices.filter(d=>d.kind==='videoinput');
      vids.sort((a,b)=> labelScore(b.label)-labelScore(a.label));
      envDevice = vids.find(d=>/(back|rear|environment|main|tele|wide)/i.test(d.label||'')) || vids[0] || null;
    }

    function scanStatus(){ const s=$('#scanStatus'); if(s) s.textContent=`r:${decodeCount} ‚Ä¢ nf:${notFoundCount}`; }

    function supportsTorch(){
      try{
        if (!lastStream) return false;
        const track = lastStream.getVideoTracks && lastStream.getVideoTracks()[0];
        if (!track || !track.getCapabilities) return false;
        const caps = track.getCapabilities();
        return 'torch' in caps;
      }catch(_){ return false; }
    }
    async function setTorch(on){
      try{
        if (!lastStream) return;
        const track=lastStream.getVideoTracks()[0];
        await track.applyConstraints({ advanced:[{ torch: !!on }] });
        torchOn=!!on; updateTorchButton();
      }catch(e){ /* ignore */ }
    }
    function updateTorchButton(){
      const btn=$('#btnTorch'); if (!btn) return;
      if (supportsTorch()){
        btn.style.display=''; btn.textContent = torchOn ? 'üí° Lampa AV' : 'üí° Lampa P√Ö';
        btn.onclick = ()=> setTorch(!torchOn);
      } else {
        btn.style.display='none';
      }
    }
    function setupZoom(){
      const video = $('#video');
      const track = video && video.srcObject ? video.srcObject.getVideoTracks()[0] : null;
      if (!track || !track.getCapabilities) return;
      const caps = track.getCapabilities();
      const wrap = $('#zoomWrap');
      const slider = $('#zoomSlider');
      const label = $('#zoomVal');
      if (caps.zoom){
        wrap.style.display='flex';
        slider.min = caps.zoom.min || 1;
        slider.max = caps.zoom.max || 1;
        slider.step = caps.zoom.step || 0.1;
        const s = track.getSettings && track.getSettings();
        if (s && s.zoom) slider.value = s.zoom;
        label.textContent = (Number(slider.value)||1).toFixed(1)+'√ó';
        slider.oninput = async ()=>{
          const val = Number(slider.value)||1;
          label.textContent = val.toFixed(1)+'√ó';
          try{ await track.applyConstraints({ advanced: [{ zoom: val }] }); }catch(_){}
        };
      } else {
        wrap.style.display='none';
      }
    }

    async function startScanner(){
      try{
        $('#scanOverlay').style.display='flex';
        decodeCount=0; notFoundCount=0; scanStatus();
        // preflight f√∂r environment (s√• att labels finns)
        try{
          const pre = await navigator.mediaDevices.getUserMedia({ video: { facingMode:{ exact:'environment' }, width:{ideal:1920}, height:{ideal:1080} } });
          const v=$('#video'); v.srcObject=pre; lastStream=pre;
        }catch(_){}
        await pickEnvironmentCamera();
        await startZXing();
      }catch(e){ toast('Startfel: '+(e?.message||e)); setBadge2('Startfel'); }
    }
    window.__startScanner = startScanner;

    async function stopScanner(){
      $('#scanOverlay').style.display='none';
      try{ codeReader && codeReader.reset(); }catch(_){}
      if (lastStream){ try{ lastStream.getTracks().forEach(t=>t.stop()); }catch(_){ } lastStream=null; }
      clearInterval(watchdogTimer); watchdogTimer=null;
      setBadge2('JS laddat ‚úÖ (v8.5)');
    }

    function onDetectedEAN(text){
      decodeCount++; scanStatus();
      const ean=String(text).replace(/[^0-9X]/g,'');
      if (!ean) return;
      const eanInput=$('#ean'); if (eanInput) eanInput.value=ean;
      beep(); stopScanner();
    }

    async function startZXing(){
      const reader=makeReader();
      async function restartZXing(){
        try{ reader.reset(); }catch(_){}
        notFoundCount=0; scanStatus();
        const constraints = {
          video: {
            deviceId: envDevice && envDevice.deviceId ? { exact: envDevice.deviceId } : undefined,
            facingMode: envDevice ? undefined : { exact: 'environment' },
            width:{ ideal:1920 }, height:{ ideal:1080 }, frameRate:{ ideal:30 }, advanced:[{ focusMode:'continuous' }]
          }
        };
        try{
          await reader.decodeFromConstraints(constraints, 'video', (result, err)=>{
            if (result && result.text){ onDetectedEAN(result.text); }
            else if (err && !(err instanceof ZXing.NotFoundException)){ setBadge2('ZXing-fel: '+err); }
            else if (err instanceof ZXing.NotFoundException){ notFoundCount++; if (notFoundCount%25===0) scanStatus(); }
          });
          setTimeout(()=>{
            const v=$('#video');
            lastStream = v && v.srcObject ? v.srcObject : null;
            const t = lastStream && lastStream.getVideoTracks ? lastStream.getVideoTracks()[0] : null;
            const st = t && t.getSettings ? t.getSettings() : {};
            $('#camInfo').textContent = (t?.label||'Normalkamera (environment)')+' '+(st.width||'')+'x'+(st.height||'');
            setupZoom(); updateTorchButton();
            if (t){ t.onended = ()=>{ setBadge2('Str√∂m slutade ‚Äì startar om'); restartZXing(); }; }
          }, 400);
        }catch(e){
          setBadge2('Kunde inte starta normalkamera'); toast('Kunde inte starta normalkamera');
        }
      }
      await restartZXing();
      clearInterval(watchdogTimer);
      watchdogTimer=setInterval(()=>{ if (!trackAlive()){ setBadge2('Watchdog: startar om'); restartZXing(); } }, 3000);
      // s√§kerhets√•terstart om 0 tr√§ffar efter 20 sekunder
      setTimeout(()=>{ if (decodeCount===0){ setBadge2('Auto-omstart (inga tr√§ffar)'); restartZXing(); } }, 20000);
    }

    function beep(){
      try{
        const ctx=new (window.AudioContext||window.webkitAudioContext)();
        const o=ctx.createOscillator(); const g=ctx.createGain();
        o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.35, ctx.currentTime+0.01);
        o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.06); o.stop(ctx.currentTime+0.1); }, 100);
      }catch(_){}
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // UI binds
      const btnSave=$('#btnSave'); btnSave && btnSave.addEventListener('click', hookSave);
      const btnSaveTop=$('#btnSaveTop'); btnSaveTop && btnSaveTop.addEventListener('click', hookSave);
      const btnClear=$('#btnClear'); btnClear && btnClear.addEventListener('click', clearForm);
      const btnAddTest=$('#btnAddTest'); btnAddTest && btnAddTest.addEventListener('click', ()=>{
        const list=store.load();
        list.push({ id:(crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now()+Math.random()), artist:'Testartist', title:'Testalbum', year:'1979', format:'LP', ean:String(Math.floor(1000000000000 + Math.random()*8999999999999)), purchaseDate:new Date().toISOString().slice(0,10), purchasePrice:50, askPrice:100, paidPrice:0, stockQty:1, thumbUrl:'' });
        store.save(list); render();
      });
      const btnExport=$('#btnExport'); btnExport && btnExport.addEventListener('click', ()=>{
        const blob=new Blob([JSON.stringify(store.load()||[], null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='vinyl_records.json'; a.click();
      });
      const btnImport=$('#btnImport'); btnImport && btnImport.addEventListener('click', ()=>{
        const input=document.createElement('input'); input.type='file'; input.accept='application/json';
        input.onchange=async (e)=>{ const f=e.target.files[0]; if(!f) return; const text=await f.text(); try{ const arr=JSON.parse(text); if(!Array.isArray(arr)) throw new Error('Inte en array'); store.save(arr); render(); }catch(err){ alert('Ogiltig JSON: '+err.message); } };
        input.click();
      });
      const btnReset=$('#btnReset'); btnReset && btnReset.addEventListener('click', ()=>{ if (!confirm('Nollst√§lla registret i '+store.label+'?')) return; store.clear(); render(); });

      const btnStopScan=$('#btnStopScan'); btnStopScan && btnStopScan.addEventListener('click', stopScanner);

      setBadge2('JS laddat ‚úÖ (v8.5)');
      render();
    });
  })();
  </script>
</body>
</html>
