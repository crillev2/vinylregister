<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vinylregister ‚Äì Single File + Skanner v2</title>
  <style>
    :root { --fg:#111; --muted:#555; --line:#e5e5e5; --bg:#ffffff; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); background:#fff; margin:16px; }
    h1{ margin:0 0 12px; }
    .wrap{ border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field span{ font-size:.9rem; color:var(--muted); }
    input.manual{ padding:8px; border:1px solid #dbe7ff; border-radius:8px; background:#f8fbff; }
    input.manual:focus{ outline:2px solid #9ec5ff; background:#fff; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn{ border:1px solid var(--line); border-radius:10px; padding:8px 12px; background:#fafafa; cursor:pointer; }
    .btn:hover{ background:#f0f0f0; }
    .btn.danger{ border-color:#f3c2c2; background:#fff5f5; }
    .btn.danger:hover{ background:#ffecec; }
    .table-wrap{ border:1px solid var(--line); border-radius:12px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:10px; border-bottom:1px solid #f0f0f0; text-align:left; }
    th{ background:#fafafa; }
    td.right, th.right{ text-align:right; }
    .col-ean{ display:none !important; } /* d√∂lj EAN-kolumnen */
    #quickSearch{ width:100%; margin:8px 0 12px; }
    .badge{ position:fixed; right:12px; bottom:12px; background:#F0FFF5; border:1px solid #9ad27e; padding:4px 8px; border-radius:6px; font-size:12px; z-index:99999; white-space:nowrap; }
    .badge-left{ position:fixed; left:12px; bottom:12px; background:#F0FFF5; border:1px solid #9ad27e; padding:4px 8px; border-radius:6px; font-size:12px; z-index:99999; white-space:nowrap; }
    .note{ font-size:12px; color:var(--muted); }
    /* Scanner overlay */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:9999; }
    .scan-card{ background:#fff; border-radius:12px; padding:12px; width:min(720px, 94vw); }
    .scan-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .scan-video-wrap{ position:relative; }
    .scan-video{ width:100%; border-radius:8px; background:#000; aspect-ratio:16/9; }
    .guides{ position:absolute; inset:0; pointer-events:none; display:grid; place-items:center; }
    .guide-box{ width:70%; height:48%; border:2px solid rgba(0,255,120,.9); border-radius:12px; box-shadow: 0 0 0 9999px rgba(0,0,0,.25) inset; }
    .scan-row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .hint{ font-size:12px; color:#666; }
  </style>
</head>
<body>
  <h1>Vinylregister (single-file + skanner v2)</h1>

  <div class="wrap">
    <h2>Inmatning</h2>
    <div class="grid">
      <label class="field"><span>Artist</span><input id="artist" class="manual" type="text"></label>
      <label class="field"><span>Album</span><input id="album" class="manual" type="text"></label>
      <label class="field"><span>√Ör</span><input id="year" class="manual" type="number" step="1"></label>
      <label class="field"><span>Format</span><input id="format" class="manual" type="text"></label>
      <label class="field"><span>EAN</span><div class="row"><input id="ean" class="manual" type="text" style="flex:1;"><button class="btn" id="btnScan">Skanna streckkod</button></div></label>
      <label class="field"><span>Ink√∂psdatum</span><input id="purchaseDate" class="manual" type="date"></label>
      <label class="field"><span>Ink√∂pspris</span><input id="purchasePrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>Beg√§rt pris</span><input id="askPrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>S√•lt (betalt pris)</span><input id="paidPrice" class="manual" type="number" step="1"></label>
      <label class="field"><span>Antal</span><input id="stockQty" class="manual" type="number" step="1" value="1"></label>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="btnSave">Spara</button>
      <button class="btn" id="btnClear">Rensa f√§lt</button>
      <span id="editHint" class="note" style="display:none;">Redigeringsl√§ge ‚Äì tryck Spara f√∂r att uppdatera posten</span>
    </div>
  </div>

  <div class="wrap" id="register">
    <h2>Register</h2>
    <input id="quickSearch" class="manual" type="search" placeholder="S√∂k artist/titel/EAN‚Ä¶">
    <div class="row" style="gap:8px; margin:6px 0;">
      <button class="btn" id="btnAddTest">‚ûï L√§gg till testpost</button>
      <button class="btn" id="btnSaveTop">Spara</button>
      <button class="btn" id="btnExport">‚¨áÔ∏è Exportera JSON</button>
      <button class="btn" id="btnImport">‚¨ÜÔ∏è Importera JSON</button>
      <button class="btn danger" id="btnReset">üßπ Nollst√§ll register</button>
      <span id="keysInfo" class="note" style="margin-left:auto;"></span>
    </div>
    <div class="table-wrap">
      <table id="registerTable">
        <thead>
          <tr>
            <th>Artist</th>
            <th>Album</th>
            <th>√Ör</th>
            <th>Format</th>
            <th data-col="ean" class="col-ean">EAN</th>
            <th class="right">Dagar</th>
            <th class="right">Ink√∂p</th>
            <th class="right">S√•lt</th>
            <th class="right">Marginal</th>
            <th class="right">√Ötg√§rd</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="badge" class="badge">Init‚Ä¶</div>
  <div id="badge2" class="badge-left">JS?</div>

  <!-- Scanner overlay -->
  <div id="scanOverlay" class="overlay">
    <div class="scan-card">
      <div class="scan-head">
        <strong>Skanna streckkod</strong>
        <div class="row">
          <select class="btn" id="cameraSelect"></select>
          <button class="btn" id="btnTorch" style="display:none;">üí° Lampa</button>
          <button class="btn danger" id="btnStopScan">St√§ng</button>
        </div>
      </div>
      <div class="scan-video-wrap">
        <video id="video" class="scan-video" autoplay muted playsinline></video>
        <div class="guides"><div class="guide-box"></div></div>
      </div>
      <div class="scan-row">
        <span class="hint">Tips: Fyll den gr√∂na rutan med streckkoden, bra ljus, h√•ll still. Skannern stoppar n√§r kod hittas.</span>
      </div>
    </div>
  </div>

  <!-- ZXing f√∂r streckkod -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>

  <script>
  (function(){
    "use strict";
    const KEY='vinyl_records';
    const $=(s,r=document)=>r.querySelector(s);
    const n=v=>Number(v||0)||0;
    let editingId=null;

    const store = (function(){
      try{ localStorage.setItem('__vr_test__','1'); localStorage.removeItem('__vr_test__');
        return { label:'localStorage',
          load(){ try{ const a=JSON.parse(localStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(_){ return []; } },
          save(a){ localStorage.setItem(KEY, JSON.stringify(a)); },
          clear(){ localStorage.removeItem(KEY); }
        };
      }catch(_){}
      try{ sessionStorage.setItem('__vr_test__','1'); sessionStorage.removeItem('__vr_test__');
        return { label:'sessionStorage',
          load(){ try{ const a=JSON.parse(sessionStorage.getItem(KEY)||'[]'); return Array.isArray(a)?a:[]; }catch(_){ return []; } },
          save(a){ sessionStorage.setItem(KEY, JSON.stringify(a)); },
          clear(){ sessionStorage.removeItem(KEY); }
        };
      }catch(_){}
      let mem = [];
      return { label:'memory',
        load(){ return mem.slice(); },
        save(a){ mem = Array.isArray(a)?a.slice():[]; },
        clear(){ mem = []; }
      };
    })();

    function setBadge(msg){ const b=$('#badge'); if(b) b.textContent=msg; }
    function setBadge2(msg){ const b=$('#badge2'); if(b) b.textContent=msg; }

    function daysBetween(a,b){ a=new Date(a); b=new Date(b); if(isNaN(a)||isNaN(b)) return ''; return Math.floor((b-a)/86400000); }
    function listKeysInfo(){
      const out=[]; try{ for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); const v=localStorage.getItem(k)||''; out.push('L:'+k+'('+v.length+')'); } }catch(_){}
      try{ for(let i=0;i<sessionStorage.length;i++){ const k=sessionStorage.key(i); const v=sessionStorage.getItem(k)||''; out.push('S:'+k+'('+v.length+')'); } }catch(_){}
      return out.join(' ¬∑ ');
    }
    function hideEANColumn(tbl){
      if(!tbl || !tbl.tHead || !tbl.tHead.rows.length) return;
      const idx = Array.from(tbl.tHead.rows[0].cells).findIndex(th => th.getAttribute('data-col')==='ean' || (th.textContent||'').trim().toLowerCase()==='ean');
      if(idx<0) return;
      tbl.tHead.rows[0].cells[idx].classList.add('col-ean');
      Array.from(tbl.tBodies).forEach(tbody=> Array.from(tbody.rows).forEach(tr=> tr.cells[idx] && tr.cells[idx].classList.add('col-ean')));
    }

    function render(){
      const list=store.load();
      let changed=false;
      for (let i=0;i<list.length;i++){
        if (!list[i].id){
          list[i].id = (crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now()+Math.random());
          changed=true;
        }
      }
      if (changed) store.save(list);

      setBadge(`Single-file ‚Ä¢ ${list.length} poster ‚Ä¢ Storage: ${store.label}`);
      const ki=$('#keysInfo'); if(ki) ki.textContent = 'Nycklar: ' + (listKeysInfo() || '‚Äî');

      const tb=$('#registerTable tbody'); if(!tb) return;
      tb.innerHTML='';
      const today = new Date();
      list.forEach(rec=>{
        const tr=document.createElement('tr');
        const margin=(n(rec.paidPrice)&&n(rec.purchasePrice))?(n(rec.paidPrice)-n(rec.purchasePrice)):'';
        const dgl=rec.purchaseDate?daysBetween(rec.purchaseDate,today):'';
        tr.innerHTML = `
          <td>${rec.artist||''}</td>
          <td>${rec.title||''}</td>
          <td>${rec.year||''}</td>
          <td>${rec.format||''}</td>
          <td class="col-ean">${rec.ean||''}</td>
          <td class="right">${dgl}</td>
          <td class="right">${rec.purchasePrice||''}</td>
          <td class="right">${rec.paidPrice||''}</td>
          <td class="right">${margin}</td>
          <td class="right">
            <button class="btn" data-act="edit" data-id="${rec.id}">Redigera</button>
            <button class="btn danger" data-act="del" data-id="${rec.id}">Ta bort</button>
          </td>`;
        tb.appendChild(tr);
      });
      hideEANColumn($('#registerTable'));
    }

    function buildFromForm(){
      const g=id=>($('#'+id)&&$('#'+id).value)||'';
      return {
        id: editingId || ((crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now())),
        artist: g('artist').trim(),
        title:  g('album').trim(),
        year:   g('year'),
        format: g('format'),
        ean:    g('ean'),
        purchaseDate: g('purchaseDate'),
        purchasePrice: n(g('purchasePrice')),
        askPrice:      n(g('askPrice')),
        paidPrice:     n(g('paidPrice')),
        stockQty:      n(g('stockQty')) || 1,
        thumbUrl: ''
      };
    }
    function clearForm(){
      ['artist','album','year','format','ean','purchaseDate','purchasePrice','askPrice','paidPrice','stockQty'].forEach(id=>{
        const el=$('#'+id); if(!el) return;
        el.value = (id==='stockQty')?1:'';
      });
      const eh=$('#editHint'); if(eh) eh.style.display='none';
      editingId=null;
    }

    function hookSave(){
      const rec = buildFromForm();
      const list = store.load();
      const idx = list.findIndex(r=> r.id===rec.id);
      if (idx>=0) list[idx]=rec; else list.push(rec);
      store.save(list); render(); clearForm();
    }

    // --- Scanner v2 ---
    let codeReader = null;
    let currentDeviceId = null;
    let lastStream = null;
    let torchOn = false;

    const HINTS = (function(){
      try{
        const hints = new Map();
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
          ZXing.BarcodeFormat.EAN_13,
          ZXing.BarcodeFormat.EAN_8,
          ZXing.BarcodeFormat.UPC_A,
          ZXing.BarcodeFormat.UPC_E
        ]);
        hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
        return hints;
      }catch(_){ return undefined; }
    })();

    function makeReader(){
      if (!codeReader){
        try{ codeReader = new ZXing.BrowserMultiFormatReader(HINTS); }
        catch(_){ codeReader = new ZXing.BrowserMultiFormatReader(); }
      }
      return codeReader;
    }

    async function startScanner(){
      const overlay = $('#scanOverlay');
      overlay.style.display = 'flex';
      setBadge2('Startar kamera‚Ä¶');

      const reader = makeReader();
      const select = $('#cameraSelect');
      select.innerHTML='';

      // Lista kameror
      try{
        const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
        devices.forEach((d,i)=>{
          const opt=document.createElement('option');
          opt.value=d.deviceId; opt.textContent=d.label || `Kamera ${i+1}`;
          select.appendChild(opt);
        });
        if (devices.length){ currentDeviceId = devices[0].deviceId; select.value = currentDeviceId; }
      }catch(e){ console.warn(e); }

      select.onchange = ()=>{
        currentDeviceId = select.value || null;
        restartDecode();
      };

      async function restartDecode(){
        try{ reader.reset(); }catch(_){}
        torchOn = false;
        const constraints = {
          video: {
            deviceId: currentDeviceId ? { exact: currentDeviceId } : undefined,
            facingMode: currentDeviceId ? undefined : { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 },
            aspectRatio: { ideal: 1.777 },
            frameRate: { ideal: 30 }
          }
        };
        try{
          await reader.decodeFromConstraints(constraints, 'video', (result, err) => {
            if (result && result.text){
              onResult(result.text);
            } else if (err && !(err instanceof ZXing.NotFoundException)){
              console.warn('Scan error:', err);
            }
          });
          // v√§nta lite och plocka str√∂mmen
          await new Promise(r=>setTimeout(r, 300));
          const video = $('#video');
          lastStream = video && video.srcObject ? video.srcObject : null;
          updateTorchButton();
        }catch(e){
          console.error(e);
          setBadge2('Kunde inte starta kamera');
        }
      }

      function onResult(text){
        const ean = String(text).replace(/[^0-9X]/g,'');
        const eanInput = $('#ean');
        if (eanInput){ eanInput.value = ean; }
        beep();
        stopScanner();
      }

      function supportsTorch(){
        try{
          if (!lastStream) return false;
          const track = lastStream.getVideoTracks && lastStream.getVideoTracks()[0];
          if (!track) return false;
          const caps = track.getCapabilities && track.getCapabilities();
          return !!(caps && 'torch' in caps);
        }catch(_){ return false; }
      }

      async function setTorch(on){
        try{
          if (!lastStream) return;
          const track = lastStream.getVideoTracks()[0];
          await track.applyConstraints({ advanced: [{ torch: !!on }] });
          torchOn = !!on;
          updateTorchButton();
        }catch(e){ console.warn('Torch not supported:', e); }
      }

      function updateTorchButton(){
        const btn = $('#btnTorch');
        if (!btn) return;
        if (supportsTorch()){
          btn.style.display = '';
          btn.textContent = torchOn ? 'üí° Lampa AV' : 'üí° Lampa P√Ö';
        } else {
          btn.style.display = 'none';
        }
      }

      $('#btnTorch').onclick = ()=> setTorch(!torchOn);

      restartDecode();
    }

    function stopScanner(){
      const overlay = $('#scanOverlay');
      overlay.style.display = 'none';
      try{ codeReader && codeReader.reset(); }catch(_){}
      if (lastStream){
        try{ lastStream.getTracks().forEach(t=>t.stop()); }catch(_){}
        lastStream = null;
      }
      setBadge2('JS laddat ‚úÖ');
    }

    function beep(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='sine'; o.frequency.value=880;
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime+0.01);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.05); o.stop(ctx.currentTime+0.07); }, 80);
      }catch(_){}
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Bekr√§fta att JS k√∂rs
      setBadge2('JS laddat ‚úÖ');

      const btnSave=$('#btnSave');
      const btnSaveTop=$('#btnSaveTop');
      if (btnSave) btnSave.addEventListener('click', hookSave);
      if (btnSaveTop) btnSaveTop.addEventListener('click', hookSave);

      const btnClear=$('#btnClear'); if(btnClear) btnClear.addEventListener('click', clearForm);
      const btnAddTest=$('#btnAddTest'); if(btnAddTest) btnAddTest.addEventListener('click', ()=>{
        const list=store.load();
        list.push({
          id:(crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now()+Math.random()),
          artist:'Testartist', title:'Testalbum', year:'1979', format:'LP',
          ean:String(Math.floor(1000000000000 + Math.random()*8999999999999)),
          purchaseDate:new Date().toISOString().slice(0,10),
          purchasePrice:50, askPrice:100, paidPrice:0, stockQty:1, thumbUrl:''
        });
        store.save(list); render();
      });
      const btnExport=$('#btnExport'); if(btnExport) btnExport.addEventListener('click', ()=>{
        const blob=new Blob([JSON.stringify(store.load()||[], null, 2)], {type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='vinyl_records.json'; a.click();
      });
      const btnImport=$('#btnImport'); if(btnImport) btnImport.addEventListener('click', ()=>{
        const input=document.createElement('input'); input.type='file'; input.accept='application/json';
        input.onchange = async (e)=>{
          const file=e.target.files[0]; if(!file) return;
          const text=await file.text();
          try{ const arr=JSON.parse(text); if(!Array.isArray(arr)) throw new Error('Inte en array'); store.save(arr); render(); }
          catch(err){ alert('Ogiltig JSON: '+err.message); }
        };
        input.click();
      });
      const btnReset=$('#btnReset'); if(btnReset) btnReset.addEventListener('click', ()=>{
        if (!confirm('Nollst√§lla registret i ' + store.label + '?')) return;
        store.clear(); render();
      });
      const qs=$('#quickSearch'); if(qs) qs.addEventListener('input', function(){
        const q=this.value.toLowerCase();
        const tb=$('#registerTable tbody');
        if (!tb) return;
        tb.querySelectorAll('tr').forEach(tr=>{
          tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      });

      // Scanner-knappar
      const btnScan=$('#btnScan'); if(btnScan) btnScan.addEventListener('click', startScanner);
      const btnStopScan=$('#btnStopScan'); if(btnStopScan) btnStopScan.addEventListener('click', stopScanner);

      document.addEventListener('click', (e)=>{
        const btn=e.target.closest('button[data-act]'); if(!btn) return;
        const id=btn.getAttribute('data-id'); const act=btn.getAttribute('data-act');
        const list=store.load();
        const idx=list.findIndex(r=> r.id===id);
        if (idx<0) return;

        if (act==='del'){
          if (!confirm('Ta bort denna post?')) return;
          list.splice(idx,1); store.save(list); render(); return;
        }
        if (act==='edit'){
          const rec=list[idx];
          const S=(id,v)=>{ const el=$('#'+id); if(el) el.value=v||''; };
          S('artist',rec.artist); S('album',rec.title); S('year',rec.year); S('format',rec.format);
          S('ean',rec.ean); S('purchaseDate',rec.purchaseDate); S('purchasePrice',rec.purchasePrice);
          S('askPrice',rec.askPrice); S('paidPrice',rec.paidPrice); S('stockQty',rec.stockQty||1);
          editingId = rec.id;
          const eh=$('#editHint'); if(eh) eh.style.display='inline-block';
          window.scrollTo({top:0, behavior:'smooth'});
        }
      }, true);

      render();
    });
  })();
  </script>
</body>
</html>
