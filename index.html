<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vinylregister â€“ v9 (ENV, en variant)</title>
  <style>
    :root { --fg:#111; --muted:#555; --line:#e5e5e5; --bg:#ffffff; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg); background:#fff; margin:16px; }
    h1{ margin:0 0 12px; }
    .wrap{ border:1px solid var(--line); border-radius:12px; padding:12px; margin:12px 0; }
    .wrap-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field span{ font-size:.9rem; color:var(--muted); }
    input.manual{ padding:8px; border:1px solid #dbe7ff; border-radius:8px; background:#f8fbff; }
    input.manual:focus{ outline:2px solid #9ec5ff; background:#fff; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn{ border:1px solid var(--line); border-radius:10px; padding:8px 12px; background:#fafafa; cursor:pointer; }
    .btn:hover{ background:#f0f0f0; }
    .btn.primary{ border-color:#cce2ff; background:#eef6ff; }
    .note{ font-size:12px; color:var(--muted); }
    .badge{ position:fixed; right:12px; bottom:12px; background:#F0FFF5; border:1px solid #9ad27e; padding:4px 8px; border-radius:6px; font-size:12px; z-index:99999; white-space:nowrap; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:56px; background:#222; color:#fff; font-size:12px; padding:8px 12px; border-radius:8px; z-index:99999; opacity:.95; }
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:9999; }
    .scan-card{ background:#fff; border-radius:12px; padding:12px; width:min(860px, 96vw); }
    .scan-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
    .scan-video{ width:100%; border-radius:8px; background:#000; aspect-ratio:16/9; }
    .status{ font-size:12px; color:#333; padding:4px 8px; background:#f5f5f5; border:1px solid #eee; border-radius:6px; }
  </style>
</head>
<body>
  <h1>Vinylregister â€“ v9 (Environment, enda varianten)</h1>

  <div class="wrap">
    <div class="wrap-head">
      <h2>Inmatning</h2>
      <button class="btn primary" id="btnScan">ðŸ“· Skanna streckkod</button>
    </div>
    <div class="grid">
      <label class="field"><span>EAN</span><input id="ean" class="manual" type="text" inputmode="numeric" pattern="[0-9]*"></label>
      <label class="field"><span>Artist</span><input id="artist" class="manual" type="text"></label>
      <label class="field"><span>Album</span><input id="album" class="manual" type="text"></label>
      <label class="field"><span>Ã…r</span><input id="year" class="manual" type="number" step="1"></label>
      <label class="field"><span>Format</span><input id="format" class="manual" type="text"></label>
    </div>
    <p class="note">Tips: hÃ¥ll telefonen i <b>landskapslÃ¤ge</b> (bred) nÃ¤r du skannar â€“ EAN Ã¤r lÃ¥ngsmal.</p>
  </div>

  <div id="badge" class="badge">Initâ€¦</div>

  <!-- Scanner overlay -->
  <div id="scanOverlay" class="overlay">
    <div class="scan-card">
      <div class="scan-head">
        <strong>Skanna â€“ normalkamera (environment)</strong>
        <button class="btn" id="btnStop">StÃ¤ng</button>
      </div>
      <video id="video" class="scan-video" autoplay muted playsinline></video>
      <div class="row">
        <span id="camInfo" class="note"></span>
        <span id="scanStatus" class="status"></span>
      </div>
    </div>
  </div>

  <!-- ZXing -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0"></script>

  <script>
  (function(){
    "use strict";
    const $=(s,r=document)=>r.querySelector(s);
    const toast=(m)=>{ const t=document.createElement('div'); t.className='toast'; t.textContent=m; document.body.appendChild(t); setTimeout(()=>t.remove(), 1600); };
    const setBadge=(m)=>{ const b=$('#badge'); if(b) b.textContent=m; };

    let reader=null, currentDeviceId=null, lastStream=null, hits=0, misses=0;

    function hintsReader(){
      try{
        const hints=new Map();
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.UPC_A, ZXing.BarcodeFormat.UPC_E]);
        hints.set(ZXing.DecodeHintType.TRY_HARDER,true);
        return new ZXing.BrowserMultiFormatReader(hints);
      }catch(_){ return new ZXing.BrowserMultiFormatReader(); }
    }
    function status(){ const s=$('#scanStatus'); if(s) s.textContent=`r:${hits} â€¢ nf:${misses}`; }

    async function pickEnvironmentId(){
      const devices=await navigator.mediaDevices.enumerateDevices();
      const vids=devices.filter(d=>d.kind==='videoinput');
      // vÃ¤lj den som tydligt Ã¤r back/rear/environment/main, annars sista enheten
      const best = vids.find(d=>/(back|rear|environment|main|tele|wide)/i.test(d.label||'')) || vids[vids.length-1] || vids[0] || null;
      currentDeviceId = best && best.deviceId || null;
      return currentDeviceId;
    }

    function stop(){
      try{ reader && reader.reset(); }catch(_){}
      if (lastStream){ try{ lastStream.getTracks().forEach(t=>t.stop()); }catch(_){ } lastStream=null; }
      $('#scanOverlay').style.display='none';
      setBadge('Klar');
    }

    async function start(){
      if (!window.ZXing || !ZXing.BrowserMultiFormatReader){
        alert('Kunde inte ladda skannermotorn. Kontrollera internet (CDN) och HTTPS.');
        return;
      }
      try{
        $('#scanOverlay').style.display='flex';
        hits=0; misses=0; status();
        reader = hintsReader();

        // Preflight â€“ fÃ¥ labels fÃ¶r att hitta "environment"
        try{
          await navigator.mediaDevices.getUserMedia({ video: { facingMode:{ ideal:'environment' }, width:{ideal:1280}, height:{ideal:720}, aspectRatio:{ideal:16/9} } });
        }catch(_){ /* ignore */}

        const id = await pickEnvironmentId();

        await reader.decodeFromVideoDevice(id, 'video', (result, err, controls)=>{
          const v=$('#video');
          if (v && v.srcObject) { lastStream=v.srcObject; }
          try{
            const t=lastStream?.getVideoTracks?.()[0];
            const st=t?.getSettings?.()||{};
            $('#camInfo').textContent = (t?.label||'Kamera')+' '+(st.width||'')+'x'+(st.height||'')+' '+(st.facingMode||'');
          }catch(_){}
          if (result && result.text){
            hits++; status();
            const ean = String(result.text).replace(/[^0-9X]/g,'');
            const el=$('#ean'); if (el) el.value=ean;
            toast('EAN: '+ean);
            stop();
            controls && controls.stop();
          } else if (err){
            if (err instanceof ZXing.NotFoundException){
              misses++; if (misses%25===0) status();
            } else {
              // andra fel â€“ visa tyst i badge och fortsÃ¤tt
              setBadge('Fel: '+(err.message||err));
            }
          }
        });

        setBadge('Skanning igÃ¥ng');

      }catch(e){
        setBadge('Startfel');
        const protoOk = location.protocol==='https:';
        alert((protoOk?'':'OBS: KrÃ¤ver HTTPS. ') + 'Kunde inte starta kameran: '+(e.name||'')+' '+(e.message||e));
        stop();
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      $('#btnScan').addEventListener('click', start);
      $('#btnStop').addEventListener('click', stop);
      setBadge('JS laddat âœ… (v9)');
    });
  })();
  </script>
</body>
</html>
